<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>note20200821 | 米惜</title><meta name="keywords" content="笔记,逆向"><meta name="author" content="Ivoripuion,carsge@tencent.com"><meta name="copyright" content="Ivoripuion"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="note20200821"><meta name="application-name" content="note20200821"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="note20200821"><meta property="og:url" content="http://example.com/2023/10/16/note20200821/index.html"><meta property="og:site_name" content="米惜"><meta property="og:description" content="Hook的分类Address Hook即修改某些函数的地址，他们可能存放在某个函数表中，可能是存在例程中，可能是在MSR寄存器中，也可能是某个特点函数指针。   各类表中的地址 PE的IAT  仅针对某个PE的模块的IAT进行Hook，想要对加载的所有模块起作用就必须变量进程内模块，对目标API进行"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://example.com/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png"><meta property="article:author" content="Ivoripuion"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png"><meta name="description" content="Hook的分类Address Hook即修改某些函数的地址，他们可能存放在某个函数表中，可能是存在例程中，可能是在MSR寄存器中，也可能是某个特点函数指针。   各类表中的地址 PE的IAT  仅针对某个PE的模块的IAT进行Hook，想要对加载的所有模块起作用就必须变量进程内模块，对目标API进行"><link rel="shortcut icon" href="/img/me.jpg"><link rel="canonical" href="http://example.com/2023/10/16/note20200821/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?855d9db99474dd0e98e385c4b629eeee";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"(❁´◡`❁)","backTitle":"(●'◡'●)"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Ivoripuion","link":"链接: ","source":"来源: 米惜","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '米惜',
  title: 'note20200821',
  postAI: '',
  pageFillDescription: 'Hook的分类, Address Hook, 各类表中的地址, 处理例程地址, 特殊基础器中的地址, 特定的函数指针, Inline Hook, jmp xxxxxxxx(5字节), push xxxxxxxxx2Fret(6字节), mov eaxxxxxxxxx2Fjmp eax(7字节), call Hook(更换指令或输入表), HotPatch Hook, 基于异常处理的Hook, 一些不是Hook的Hook, PE文件被感染导致OEP被修改, 系统回调机制和分层模型, Hook位置的挑选, Hook的典型过程, Address Hook实施过程, IAT Hook, 虚函数Hook, SSDT Hook, Inline Hook实施过程, 具体过程, tips, Hook的检测, Address Hook检测, Inline Hook检测的分类即修改某些函数的地址他们可能存放在某个函数表中可能是存在例程中可能是在寄存器中也可能是某个特点函数指针各类表中的地址的仅针对某个的模块的进行想要对加载的所有模块起作用就必须变量进程内模块对目标进行的存放的是函数地址的偏移所以想要使用针对的就需要计算目标函数与修改后函数地址的偏该方式的进行后所有试图通过输入表获取函数地址的行为都会收到影响的回调函数表中的的回调函数表存放了各种用于的回调函数当修改了这里的函数地址后就可以进行即系统中断的基址存放在寄存器中表内项目数存放在寄存器中每个中断项的中断处理例程成为以及表即系统服务描述符表在调用系统服务处理时使用表用于处理各种服务类的虚函数表即类中第一个地址该地址为虚函数表的地址接口的功能函数表接口函数都放在一个函数中与虚函数表类似处理例程地址的及派遣例程地址调试结果的函数表函数表等特殊例程的地址在对象中中包含的各种处理过程特殊基础器中的地址使用寄存器组中的的值作为内核调用的入口当在中调用汇编指令进入内核时会首先执行到这里可以修改寄存器中保存的快速调用入口函数地址特定的函数指针特定的函数指针存放在一个已知的地址中如函数存在指针中这些函数都与处理有关直接修改指令的一般有种模式字节直接跳转字节通过压栈返回实现跳转到字节更换指令或输入表类似只不过是直接修改中的指令指向的函数地址如为一个短跳加一个长跳个字节如入口地址改为入口地址跳转到上一条长跳可以通用不管有没有的入口基于异常处理的其实就是修改或者链中存放或者处理函数的地址一些不是的文件被感染导致被修改系统回调机制和分层模型各种回调机制如消息钩子以及内核中各种回调分层服务和过滤驱动模型如服务提供者以及驱动模型位置的挑选从用户程序到端口驱动越往下得到的控制权就越晚也越难被绕过应用层上对就已经够用了内核中一般和以及用于切换的比较方便的典型过程以及都需要定义一个函数替代被的函数其原型调用约定以及返回值都需要与原函数一样以为例自定义函数如下这里使用来显示定义函数与被函数调用约定一样为否则在默认编译时对函数默认调用约定为如果在函数中调用原函数来实现功能就需要某种方式调用原函数这里与方式是不一样的实施过程处理定义函数还需要定义一个与被函数原型一致的函数指针指向原始函数然后查表替换原地址关闭写保护以及写入函数地址获取目标函数地址获取待模块输入表的起始地址里存储的就是的找到需要的模块当前模块名称不是需求匹配的模块找到目标地址修改输入表内存页为可写存放虚拟页找到目标虚拟页将虚拟页修改为可修改成功修改地址恢复内存地址目标函数地址被为实验结果虚函数几个注意点确定目标函数在目标雷中的位置以及函数原型定义和修改虚函数表实现定义函数以及一个函数指针通过硬编码方式检索系统版本找出索引去掉虚拟页写保护这里可以通过清楚控制寄存器安装实施过程几个概念用被的目标函数用于替代的自定义函数调用函数的入口在该函数中要执行的中被替换的前几条指令具体过程这里针对进行实验确定方式以及在中使用的指令可以观察到函数开头如下正好是个字节使用长跳的机器码进行即将这几个字节修改为如下形式当函数执行完毕需要使用调用这三条指令来正常调用原函数设置函数保存原函数正常执行将指令写入并设置即可这里为了方便显示的结果写了个小程序开始的个字节测试结果这里由于没有对源代码的一部分进行修改导致了地址的错误这里就演示一下字节的修改前后使用以及函数可以方便的读写内存方便的显示指定地址字节的内容的函数设计开始的个字节的检测检测寻找原始的与当前进行对比加载待检测的模块然后对进行对比将内核文件加载手动计算实际地址然后进行对比一些无法获取确切地址的检测是否再这个驱动模块的地址范围检测步骤如下加载待检测的映像根据实际地址进行重定位对代码所在的节进行检查和比对',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-21 22:34:52',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/avater.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://ivoripuion.github.io/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/Ivoripuion" title="米惜的github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/me.jpg" alt="米惜的github"/><span class="back-menu-item-text">米惜的github</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">米惜</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=870146543&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BAS/" style="font-size: 1.05rem;">BAS<sup>1</sup></a><a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">Java安全<sup>2</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>5</sup></a><a href="/tags/Windows/" style="font-size: 1.05rem;">Windows<sup>9</sup></a><a href="/tags/blackhat2023/" style="font-size: 1.05rem;">blackhat2023<sup>1</sup></a><a href="/tags/fuzz/" style="font-size: 1.05rem;">fuzz<sup>6</sup></a><a href="/tags/pwn/" style="font-size: 1.05rem;">pwn<sup>1</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>1</sup></a><a href="/tags/%E4%B8%B4%E5%BA%8A/" style="font-size: 1.05rem;">临床<sup>2</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">二进制安全<sup>2</sup></a><a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">云安全<sup>4</sup></a><a href="/tags/%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F/" style="font-size: 1.05rem;">信息隐藏<sup>1</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" style="font-size: 1.05rem;">内存马<sup>1</sup></a><a href="/tags/%E5%88%91%E6%B3%95/" style="font-size: 1.05rem;">刑法<sup>1</sup></a><a href="/tags/%E5%89%A7%E6%9C%AC%E6%9D%80%E8%A7%A3%E6%9E%90/" style="font-size: 1.05rem;">剧本杀解析<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%9C%A8%E4%B8%BB%E4%B9%89/" style="font-size: 1.05rem;">存在主义<sup>3</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 1.05rem;">实战<sup>3</sup></a><a href="/tags/%E5%AE%9E%E8%B7%B5/" style="font-size: 1.05rem;">实践<sup>5</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">开发<sup>1</sup></a><a href="/tags/%E6%96%87%E5%AD%A6%E9%89%B4%E8%B5%8F/" style="font-size: 1.05rem;">文学鉴赏<sup>1</sup></a><a href="/tags/%E6%97%A5%E8%AF%AD/" style="font-size: 1.05rem;">日语<sup>1</sup></a><a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 1.05rem;">机器学习<sup>1</sup></a><a href="/tags/%E6%B3%95%E5%AD%A6/" style="font-size: 1.05rem;">法学<sup>1</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="font-size: 1.05rem;">漏洞分析<sup>22</sup></a><a href="/tags/%E7%97%85%E6%AF%92%E6%A3%80%E6%B5%8B/" style="font-size: 1.05rem;">病毒检测<sup>2</sup></a><a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 1.05rem;">笔记<sup>55</sup></a><a href="/tags/%E7%B2%BE%E7%A5%9E%E5%88%86%E6%9E%90/" style="font-size: 1.05rem;">精神分析<sup>11</sup></a><a href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91%E4%B8%BB%E6%9C%BA%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">腾讯云主机安全<sup>1</sup></a><a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size: 1.05rem;">论文阅读<sup>1</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 1.05rem;">逆向<sup>12</sup></a><a href="/tags/%E9%98%85%E8%AF%BB%E7%90%86%E8%A7%A3/" style="font-size: 1.05rem;">阅读理解<sup>1</sup></a><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 1.05rem;">随笔<sup>4</sup></a><a href="/tags/%E9%9D%9E%E9%81%93%E5%BE%B7%E4%B8%BB%E4%B9%89/" style="font-size: 1.05rem;">非道德主义<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 1.05rem;">面试题<sup>1</sup></a><a href="/tags/%E9%A9%AC%E5%85%8B%E6%80%9D%E4%B8%BB%E4%B9%89/" style="font-size: 1.05rem;">马克思主义<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">57</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">九月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">七月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">五月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/04/"><span class="card-archive-list-date">四月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/12/"><span class="card-archive-list-date">十二月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E3%80%8A%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86%E3%80%8B%E7%AC%94%E8%AE%B0/" itemprop="url">《加密与解密》笔记</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>笔记</span></a><a class="article-meta__tags" href="/tags/%E9%80%86%E5%90%91/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>逆向</span></a></span></div></div><h1 class="post-title" itemprop="name headline">note20200821</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-10-16T15:29:03.875Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-10-21T14:34:52.106Z" title="更新于 2023-10-21 22:34:52">2023-10-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">2.9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>12分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为中国"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>中国</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2023/10/16/note20200821/"><header><a class="post-meta-categories" href="/categories/%E3%80%8A%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86%E3%80%8B%E7%AC%94%E8%AE%B0/" itemprop="url">《加密与解密》笔记</a><a href="/tags/%E7%AC%94%E8%AE%B0/" tabindex="-1" itemprop="url">笔记</a><a href="/tags/%E9%80%86%E5%90%91/" tabindex="-1" itemprop="url">逆向</a><h1 id="CrawlerTitle" itemprop="name headline">note20200821</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Ivoripuion</span><time itemprop="dateCreated datePublished" datetime="2023-10-16T15:29:03.875Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time><time itemprop="dateCreated datePublished" datetime="2023-10-21T14:34:52.106Z" title="更新于 2023-10-21 22:34:52">2023-10-21</time></header><h1 id="Hook的分类"><a href="#Hook的分类" class="headerlink" title="Hook的分类"></a>Hook的分类</h1><h2 id="Address-Hook"><a href="#Address-Hook" class="headerlink" title="Address Hook"></a>Address Hook</h2><p>即修改某些函数的地址，他们可能存放在某个函数表中，可能是存在例程中，可能是在MSR寄存器中，也可能是某个特点函数指针。</p>
<span id="more"></span>

<h3 id="各类表中的地址"><a href="#各类表中的地址" class="headerlink" title="各类表中的地址"></a>各类表中的地址</h3><ol>
<li>PE的IAT</li>
</ol>
<p>仅针对某个PE的模块的IAT进行Hook，想要对加载的所有模块起作用就必须变量进程内模块，对目标API进行Hook。</p>
<ol start="2">
<li>PE的EAT</li>
</ol>
<p>EAT存放的是函数地址的偏移，所以想要使用针对EAT的Hook，就需要计算目标函数与修改后函数地址的偏。该方式的Hook进行后，所有试图通过输入表获取函数地址的行为都会收到影响。</p>
<ol start="3">
<li>user32.dll的回调函数表</li>
</ol>
<p>user32.dll中的UER32!apfnDispatch的回调函数表存放了各种用于GUI的回调函数，当修改了这里的函数地址后，就可以进行Hook。</p>
<ol start="4">
<li>IDT</li>
</ol>
<p>IDT即系统中断ID，IDT的基址存放在idtr寄存器中，表内项目数存放在idtl寄存器中，每个中断项的中断处理例程成为ISR。</p>
<ol start="5">
<li>SSDT以及Shadow SSDT</li>
</ol>
<p>SSDT表即系统服务描述符表，在API调用系统服务处理时使用。Shadow SSDT表用于处理各种GUI服务。</p>
<ol start="6">
<li>C++类的虚函数表</li>
</ol>
<p>即类中第一个地址，该地址为虚函数表的地址。</p>
<ol start="7">
<li>COM接口的功能函数表</li>
</ol>
<p>COM接口函数都放在一个函数中，与虚函数表类似。</p>
<h3 id="处理例程地址"><a href="#处理例程地址" class="headerlink" title="处理例程地址"></a>处理例程地址</h3><ol>
<li>DRIVER_OBJECT的MajorFunction及FastIo派遣例程地址。</li>
</ol>
<p>windows 7 x86调试结果：</p>
<p>ntfs的DRIVER_OBJECT：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: kd&gt; !drvobj ntfs</span><br><span class="line">Driver object (86e1c660) is for:</span><br><span class="line"> \FileSystem\Ntfs</span><br><span class="line"></span><br><span class="line">Driver Extension List: (id , addr)</span><br><span class="line"></span><br><span class="line">Device Object list:</span><br><span class="line">8789c020  8723b638  </span><br><span class="line"><span class="number">2</span>: kd&gt; <span class="built_in">dt</span> _DRIVER_OBJECT 86e1c660</span><br><span class="line">nt!_DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : 0n4</span><br><span class="line">   +<span class="number">0x002</span> Size             : 0n168</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : <span class="number">0x8789c020</span> _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x008</span> Flags            : <span class="number">0x92</span></span><br><span class="line">   +<span class="number">0x00c</span> DriverStart      : <span class="number">0x890b0000</span> Void</span><br><span class="line">   +<span class="number">0x010</span> DriverSize       : <span class="number">0x12f000</span></span><br><span class="line">   +<span class="number">0x014</span> DriverSection    : <span class="number">0x8633b2b8</span> Void</span><br><span class="line">   +<span class="number">0x018</span> DriverExtension  : <span class="number">0x86e1c708</span> _DRIVER_EXTENSION</span><br><span class="line">   +<span class="number">0x01c</span> DriverName       : _UNICODE_STRING <span class="string">&quot;\FileSystem\Ntfs&quot;</span></span><br><span class="line">   +<span class="number">0x024</span> HardwareDatabase : <span class="number">0x841b3250</span> _UNICODE_STRING <span class="string">&quot;\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM&quot;</span></span><br><span class="line">   +<span class="number">0x028</span> FastIoDispatch   : <span class="number">0x890ef900</span> _FAST_IO_DISPATCH</span><br><span class="line">   +<span class="number">0x02c</span> DriverInit       : <span class="number">0x891b39fa</span>     long  Ntfs!GsDriverEntry+<span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> DriverStartIo    : (null) </span><br><span class="line">   +<span class="number">0x034</span> DriverUnload     : (null) </span><br><span class="line">   +<span class="number">0x038</span> MajorFunction    : [<span class="number">28</span>] <span class="number">0x8915a832</span>     long  Ntfs!NtfsFsdCreate+<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><code>MajorFunction</code>函数表：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: kd&gt; dds <span class="number">0x86e1c660</span>+<span class="number">0x38</span></span><br><span class="line">86e1c698  8915a832 Ntfs!NtfsFsdCreate</span><br><span class="line">86e1c69c  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6a0  8915b3d3 Ntfs!NtfsFsdClose</span><br><span class="line">86e1c6a4  890c3a7e Ntfs!NtfsFsdRead</span><br><span class="line">86e1c6a8  890c4599 Ntfs!NtfsFsdWrite</span><br><span class="line">86e1c6ac  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c6b0  890be078 Ntfs!NtfsFsdSetInformation</span><br><span class="line">86e1c6b4  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c6b8  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c6bc  8912fc7b Ntfs!NtfsFsdFlushBuffers</span><br><span class="line">86e1c6c0  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6c4  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6c8  8915ed28 Ntfs!NtfsFsdDirectoryControl</span><br><span class="line">86e1c6cc  <span class="number">89146244</span> Ntfs!NtfsFsdFileSystemControl</span><br><span class="line">86e1c6d0  8914fefd Ntfs!NtfsFsdDeviceControl</span><br><span class="line">86e1c6d4  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6d8  <span class="number">89190847</span> Ntfs!NtfsFsdShutdown</span><br><span class="line">86e1c6dc  890cd49d Ntfs!NtfsFsdLockControl</span><br><span class="line">86e1c6e0  8915bc9e Ntfs!NtfsFsdCleanup</span><br><span class="line">86e1c6e4  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6e8  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6ec  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6f0  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6f4  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6f8  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6fc  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c700  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c704  <span class="number">89120517</span> Ntfs!NtfsFsdPnp</span><br><span class="line">86e1c708  86e1c660</span><br><span class="line">86e1c70c  <span class="number">00000000</span></span><br><span class="line">86e1c710  <span class="number">00000001</span></span><br><span class="line">86e1c714  000a0008</span><br></pre></td></tr></table></figure>

<p><code>FastIo</code>函数表：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: kd&gt; dds <span class="number">0x86e1c660</span>+<span class="number">0x28</span></span><br><span class="line">86e1c688  890ef900 Ntfs!NtfsFastIoDispatch</span><br><span class="line">86e1c68c  891b39fa Ntfs!GsDriverEntry</span><br><span class="line">86e1c690  <span class="number">00000000</span></span><br><span class="line">86e1c694  <span class="number">00000000</span></span><br><span class="line">86e1c698  8915a832 Ntfs!NtfsFsdCreate</span><br><span class="line">86e1c69c  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6a0  8915b3d3 Ntfs!NtfsFsdClose</span><br><span class="line">86e1c6a4  890c3a7e Ntfs!NtfsFsdRead</span><br><span class="line">86e1c6a8  890c4599 Ntfs!NtfsFsdWrite</span><br><span class="line">86e1c6ac  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c6b0  890be078 Ntfs!NtfsFsdSetInformation</span><br><span class="line">86e1c6b4  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c6b8  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c6bc  8912fc7b Ntfs!NtfsFsdFlushBuffers</span><br><span class="line">86e1c6c0  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6c4  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6c8  8915ed28 Ntfs!NtfsFsdDirectoryControl</span><br><span class="line">86e1c6cc  <span class="number">89146244</span> Ntfs!NtfsFsdFileSystemControl</span><br><span class="line">86e1c6d0  8914fefd Ntfs!NtfsFsdDeviceControl</span><br><span class="line">86e1c6d4  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6d8  <span class="number">89190847</span> Ntfs!NtfsFsdShutdown</span><br><span class="line">86e1c6dc  890cd49d Ntfs!NtfsFsdLockControl</span><br><span class="line">86e1c6e0  8915bc9e Ntfs!NtfsFsdCleanup</span><br><span class="line">86e1c6e4  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6e8  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6ec  8915600e Ntfs!NtfsFsdDispatch</span><br><span class="line">86e1c6f0  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6f4  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6f8  83efcda3 nt!IopInvalidDeviceRequest</span><br><span class="line">86e1c6fc  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c700  891557af Ntfs!NtfsFsdDispatchWait</span><br><span class="line">86e1c704  <span class="number">89120517</span> Ntfs!NtfsFsdPnp</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>StartIo等特殊例程的地址。</li>
</ol>
<p><code>StartIo</code>在<code>atapi</code>对象中：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: kd&gt; !drvobj atapi</span><br><span class="line">Driver object (874c6840) is for:</span><br><span class="line"> \Driver\atapi</span><br><span class="line"></span><br><span class="line">Driver Extension List: (id , addr)</span><br><span class="line">(88db2006 86d89418)  </span><br><span class="line">Device Object list:</span><br><span class="line">874bb030  8749e028  <span class="number">87495028</span>  8748c028</span><br><span class="line"><span class="number">87483028</span>  8747a028  <span class="number">87471028</span>  <span class="number">87468028</span></span><br><span class="line"><span class="number">87461028</span>  <span class="number">87455028</span>  8744c028  <span class="number">87443028</span></span><br><span class="line">8743a028  <span class="number">87431028</span>  <span class="number">87428028</span>  8741f028</span><br><span class="line"><span class="number">87416028</span>  8740d028  <span class="number">87404028</span>  873fb028</span><br><span class="line">873f2028  873e9028  873e0028  873d7028</span><br><span class="line">873ce028  873c5028  873bc028  873b3028</span><br><span class="line">873aa028  873a3028  8739c028  863da028</span><br><span class="line">863de028  </span><br><span class="line"><span class="number">2</span>: kd&gt; <span class="built_in">dt</span> _DRIVER_OBJECT 874c6840</span><br><span class="line">nt!_DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : 0n4</span><br><span class="line">   +<span class="number">0x002</span> Size             : 0n168</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : <span class="number">0x874bb030</span> _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x008</span> Flags            : <span class="number">0x12</span></span><br><span class="line">   +<span class="number">0x00c</span> DriverStart      : <span class="number">0x88e13000</span> Void</span><br><span class="line">   +<span class="number">0x010</span> DriverSize       : <span class="number">0x9000</span></span><br><span class="line">   +<span class="number">0x014</span> DriverSection    : <span class="number">0x8633b6b0</span> Void</span><br><span class="line">   +<span class="number">0x018</span> DriverExtension  : <span class="number">0x874c68e8</span> _DRIVER_EXTENSION</span><br><span class="line">   +<span class="number">0x01c</span> DriverName       : _UNICODE_STRING <span class="string">&quot;\Driver\atapi&quot;</span></span><br><span class="line">   +<span class="number">0x024</span> HardwareDatabase : <span class="number">0x841b3250</span> _UNICODE_STRING <span class="string">&quot;\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM&quot;</span></span><br><span class="line">   +<span class="number">0x028</span> FastIoDispatch   : (null) </span><br><span class="line">   +<span class="number">0x02c</span> DriverInit       : <span class="number">0x88e1903e</span>     long  atapi!GsDriverEntry+<span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> DriverStartIo    : (null) </span><br><span class="line">   +<span class="number">0x034</span> DriverUnload     : <span class="number">0x88daade6</span>     void  ataport!IdePortUnload+<span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> MajorFunction    : [<span class="number">28</span>] <span class="number">0x88daf8cc</span>     long  ataport!PortWdmAlwaysStatusSuccessIrp+<span class="number">0</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>OBJECT_TYPE中_OBJECT_TYOE_INITIALIZER包含的各种处理过程。</li>
</ol>
<h3 id="特殊基础器中的地址"><a href="#特殊基础器中的地址" class="headerlink" title="特殊基础器中的地址"></a>特殊基础器中的地址</h3><p>Windows使用MSR寄存器组中的IA32_SYSNTER_EIP的值作为内核调用的入口，当在ntdll中调用汇编指令sysenter进入内核时，CPU会首先执行到这里。可以修改MSR寄存器中保存的快速调用入口函数地址。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; <span class="keyword">rdmsr</span> <span class="number">0x176</span></span><br><span class="line">msr[<span class="number">176</span>] = <span class="number">00000000</span><span class="string">`83e790c0</span></span><br><span class="line"><span class="string">0: kd&gt; u 83e790c0</span></span><br><span class="line"><span class="string">nt!KiFastCallEntry:</span></span><br><span class="line"><span class="string">83e790c0 b923000000      mov     ecx,23h</span></span><br><span class="line"><span class="string">83e790c5 6a30            push    30h</span></span><br><span class="line"><span class="string">83e790c7 0fa1            pop     fs</span></span><br><span class="line"><span class="string">83e790c9 8ed9            mov     ds,cx</span></span><br><span class="line"><span class="string">83e790cb 8ec1            mov     es,cx</span></span><br><span class="line"><span class="string">83e790cd 648b0d40000000  mov     ecx,dword ptr fs:[40h]</span></span><br><span class="line"><span class="string">83e790d4 8b6104          mov     esp,dword ptr [ecx+4]</span></span><br><span class="line"><span class="string">83e790d7 6a23            push    23h</span></span><br></pre></td></tr></table></figure>

<h3 id="特定的函数指针"><a href="#特定的函数指针" class="headerlink" title="特定的函数指针"></a>特定的函数指针</h3><p>特定的函数指针存放在一个已知的地址中，如<code>nt!IoCompleteRequest</code>：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; u nt!IoCompleteRequest</span><br><span class="line">nt!IoCompleteRequest:</span><br><span class="line">83f14401 8bff            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line">83f14403 <span class="number">55</span>              <span class="keyword">push</span>    <span class="built_in">ebp</span></span><br><span class="line">83f14404 8bec            <span class="keyword">mov</span>     <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">83f14406 8a550c          <span class="keyword">mov</span>     <span class="built_in">dl</span>,<span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]</span><br><span class="line">83f14409 8b4d08          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">83f1440c ff15605afa83    <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [nt!pIofCompleteRequest (83fa5a60)]<span class="comment">;函数存在指针中</span></span><br><span class="line">83f14412 <span class="number">5d</span>              <span class="keyword">pop</span>     <span class="built_in">ebp</span></span><br><span class="line">83f14413 c20800          <span class="keyword">ret</span>     <span class="number">8</span></span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; <span class="built_in">dd</span> nt!pIofCompleteRequest</span><br><span class="line">83fa5a60  83eb3809 83ec0eed 83ecf3a5 <span class="number">00000003</span></span><br><span class="line">83fa5a70  <span class="number">86545000</span> <span class="number">86546000</span> <span class="number">00000120</span> ffffffff</span><br><span class="line">83fa5a80  <span class="number">00000001</span> <span class="number">00000000</span> <span class="number">00000002</span> <span class="number">00000000</span></span><br><span class="line">83fa5a90  <span class="number">00000004</span> <span class="number">00000000</span> <span class="number">00000008</span> <span class="number">00000000</span></span><br><span class="line">83fa5aa0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">83fa5ab0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">83fa5ac0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">83fa5ad0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; uu 83eb3809</span><br><span class="line">nt!IopfCompleteRequest:</span><br><span class="line">83eb3809 8bff            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line">83eb380b <span class="number">55</span>              <span class="keyword">push</span>    <span class="built_in">ebp</span></span><br><span class="line">83eb380c 8bec            <span class="keyword">mov</span>     <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">83eb380e 83e4f8          <span class="keyword">and</span>     <span class="built_in">esp</span>,<span class="number">0FFFFFFF8h</span></span><br><span class="line">83eb3811 83ec24          <span class="keyword">sub</span>     <span class="built_in">esp</span>,<span class="number">24h</span></span><br><span class="line">83eb3814 <span class="number">53</span>              <span class="keyword">push</span>    <span class="built_in">ebx</span></span><br><span class="line">83eb3815 <span class="number">56</span>              <span class="keyword">push</span>    <span class="built_in">esi</span></span><br><span class="line">83eb3816 8bf1            <span class="keyword">mov</span>     <span class="built_in">esi</span>,<span class="built_in">ecx</span></span><br></pre></td></tr></table></figure>

<p>这些函数都与IRP处理有关。</p>
<h2 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h2><p>直接修改指令的Hook。</p>
<p>一般有5种模式。</p>
<h3 id="jmp-xxxxxxxx-5字节"><a href="#jmp-xxxxxxxx-5字节" class="headerlink" title="jmp xxxxxxxx(5字节)"></a>jmp xxxxxxxx(5字节)</h3><p>直接跳转<code>xxxxxxxx</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E9 xx xx xx xx</span><br></pre></td></tr></table></figure>

<h3 id="push-xxxxxxxx-ret-6字节"><a href="#push-xxxxxxxx-ret-6字节" class="headerlink" title="push xxxxxxxx&#x2F;ret(6字节)"></a>push xxxxxxxx&#x2F;ret(6字节)</h3><p>通过压栈返回实现跳转到<code>xxxxxxxx</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">68 xx xx xx xx</span><br><span class="line">c3</span><br></pre></td></tr></table></figure>

<h3 id="mov-eax-xxxxxxx-jmp-eax-7字节"><a href="#mov-eax-xxxxxxx-jmp-eax-7字节" class="headerlink" title="mov eax,xxxxxxx&#x2F;jmp eax(7字节)"></a>mov eax,xxxxxxx&#x2F;jmp eax(7字节)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">B8 xx xx xx 00</span><br><span class="line">FF E0</span><br></pre></td></tr></table></figure>

<h3 id="call-Hook-更换指令或输入表"><a href="#call-Hook-更换指令或输入表" class="headerlink" title="call Hook(更换指令或输入表)"></a>call Hook(更换指令或输入表)</h3><p>类似Address Hook只不过是直接修改CPU中的指令<code>call</code>指向的函数地址。</p>
<p>如：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e8 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>Hook为：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e8 <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<h3 id="HotPatch-Hook"><a href="#HotPatch-Hook" class="headerlink" title="HotPatch Hook"></a>HotPatch Hook</h3><p>一个短跳加一个长跳(7个字节)。</p>
<p>如：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">90</span></span><br><span class="line"><span class="number">90</span> </span><br><span class="line"><span class="number">90</span></span><br><span class="line"><span class="number">90</span></span><br><span class="line"><span class="number">90</span></span><br><span class="line"><span class="number">90</span></span><br><span class="line">8b ff<span class="comment">;入口地址</span></span><br></pre></td></tr></table></figure>

<p>改为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e9 66 08 66 89</span><br><span class="line">eb f9;入口地址，跳转到上一条长跳</span><br></pre></td></tr></table></figure>

<p>可以通用hook不管有没有SEH的api入口。</p>
<h2 id="基于异常处理的Hook"><a href="#基于异常处理的Hook" class="headerlink" title="基于异常处理的Hook"></a>基于异常处理的Hook</h2><p>其实就是修改SEH或者VEH链中存放SEH或者VEH处理函数的地址。</p>
<h2 id="一些不是Hook的Hook"><a href="#一些不是Hook的Hook" class="headerlink" title="一些不是Hook的Hook"></a>一些不是Hook的Hook</h2><h3 id="PE文件被感染，导致OEP被修改"><a href="#PE文件被感染，导致OEP被修改" class="headerlink" title="PE文件被感染，导致OEP被修改"></a>PE文件被感染，导致OEP被修改</h3><h3 id="系统回调机制和分层模型"><a href="#系统回调机制和分层模型" class="headerlink" title="系统回调机制和分层模型"></a>系统回调机制和分层模型</h3><ol>
<li>各种回调机制；</li>
</ol>
<p>如消息钩子以及内核中各种回调。</p>
<ol start="2">
<li>分层服务和过滤驱动模型；</li>
</ol>
<p>如LSP服务提供者以及驱动模型（Class&#x2F;Port&#x2F;MiniPort）。</p>
<h1 id="Hook位置的挑选"><a href="#Hook位置的挑选" class="headerlink" title="Hook位置的挑选"></a>Hook位置的挑选</h1><p>从用户程序到端口驱动，越往下Hook得到的控制权就越晚，也越难被绕过。应用层上，对API Hook就已经够用了；内核中，一般Hook SSDT和SSDT Shaodow以及用于切换ring0 ring3的<code>KiFastCallEntry</code>比较方便。</p>
<h1 id="Hook的典型过程"><a href="#Hook的典型过程" class="headerlink" title="Hook的典型过程"></a>Hook的典型过程</h1><p>Inline Hook以及Address Hook都需要定义一个Detour函数替代被Hook的函数，其原型，调用约定以及返回值都需要与原函数一样。以<code>MessageBoxA</code>为例，自定义Detour函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">My_MessageBoxA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   HWMD hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">   LPCTSTR lpText,</span></span></span><br><span class="line"><span class="params"><span class="function">   LPCTSTR lpCaption,</span></span></span><br><span class="line"><span class="params"><span class="function">   UINT uType</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这里使用<code>WINAPI</code>来显示定义Detour函数与被Hook函数调用约定一样，为<code>__stdcall</code>，否则在VC++默认编译时，对函数默认调用约定为<code>__cdecl</code>。</p>
<p>如果在Detour函数中调用原函数来实现功能，就需要某种方式调用原函数，这里Address Hook与Inline Hook方式是不一样的。</p>
<h2 id="Address-Hook实施过程"><a href="#Address-Hook实施过程" class="headerlink" title="Address Hook实施过程"></a>Address Hook实施过程</h2><p>处理定义Detour函数，还需要定义一个与被Hook函数原型一致的函数指针，指向原始函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(WINAPI* POI_MessageBoxA)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">	LPCTSTR lpText,</span></span></span><br><span class="line"><span class="params"><span class="function">	LPCTSTR lpCaption,</span></span></span><br><span class="line"><span class="params"><span class="function">	UINT uType</span></span></span><br><span class="line"><span class="params"><span class="function"> 	)</span></span>;</span><br><span class="line">POI_MessageBoxA oldMessageBox = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>然后查表替换原地址，关闭写保护，以及写入Detour函数地址。</p>
<h3 id="IAT-Hook"><a href="#IAT-Hook" class="headerlink" title="IAT Hook"></a>IAT Hook</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">InstallModuleIATHook</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	HMODULE hModToHook,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">char</span>* szModuleName,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">char</span>* szFuncName,</span></span></span><br><span class="line"><span class="params"><span class="function">	PVOID DetourFunc,</span></span></span><br><span class="line"><span class="params"><span class="function">	PULONG* pThunkPointer,</span></span></span><br><span class="line"><span class="params"><span class="function">	ULONG* pOriginalFuncAddr</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_IMPORT_DESCRIPTOR pImportDescriptor;</span><br><span class="line">	PIMAGE_THUNK_DATA pThunkData;</span><br><span class="line">	ULONG ulSize;</span><br><span class="line">	HMODULE hModule = <span class="number">0</span>;</span><br><span class="line">	ULONG TargetFunAddr;</span><br><span class="line">	PULONG lpAddr;</span><br><span class="line">	<span class="type">char</span>* szModName;</span><br><span class="line">	BOOL result = FALSE;</span><br><span class="line">	BOOL bRetn	= FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取目标函数地址</span></span><br><span class="line">	hModule = <span class="built_in">LoadLibrary</span>(szModuleName);</span><br><span class="line">	TargetFunAddr = (ULONG)<span class="built_in">GetProcAddress</span>(hModule, szFuncName);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取待Hook模块输入表的起始地址</span></span><br><span class="line">	pImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<span class="built_in">ImageDirectoryEntryToData</span>(hModToHook,TRUE,IMAGE_DIRECTORY_ENTRY_IMPORT,&amp;ulSize);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (pImportDescriptor-&gt;FirstThunk)<span class="comment">//FirstThunk里存储的就是IAT的RVA</span></span><br><span class="line">	&#123;</span><br><span class="line">		szModName = (<span class="type">char</span>*)((PBYTE)hModToHook+pImportDescriptor-&gt;Name);<span class="comment">//找到需要Hook的模块</span></span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;当前模块名称：&quot;</span> &lt;&lt; szModName &lt;&lt; endl;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">stricmp</span>(szModName, szModuleName)!= <span class="number">0</span>) &#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;不是需求匹配的模块！&quot;</span> &lt;&lt; endl;</span><br><span class="line">			pImportDescriptor++;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		pThunkData = (PIMAGE_THUNK_DATA)((BYTE*)hModToHook + pImportDescriptor-&gt;FirstThunk);</span><br><span class="line">		<span class="keyword">while</span> (pThunkData-&gt;u1.Function)</span><br><span class="line">		&#123;</span><br><span class="line">			lpAddr = (ULONG*)pThunkData;</span><br><span class="line">			<span class="keyword">if</span> ((*lpAddr) == TargetFunAddr)</span><br><span class="line">			&#123;</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;找到目标地址！&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//修改输入表内存页为可写</span></span><br><span class="line">				DWORD dwOldProtect;</span><br><span class="line">				MEMORY_BASIC_INFORMATION mbi;<span class="comment">//存放虚拟页</span></span><br><span class="line">				<span class="built_in">VirtualQuery</span>(lpAddr, &amp;mbi, <span class="built_in">sizeof</span>(mbi));<span class="comment">//找到目标虚拟页</span></span><br><span class="line">				bRetn = <span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);<span class="comment">//将虚拟页修改为可wrx</span></span><br><span class="line">				<span class="keyword">if</span> (bRetn) &#123;</span><br><span class="line">					<span class="keyword">if</span> (pThunkData != <span class="literal">NULL</span>) &#123;<span class="comment">//修改成功</span></span><br><span class="line">						*pThunkPointer = lpAddr;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (pOriginalFuncAddr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">						*pOriginalFuncAddr = *lpAddr;</span><br><span class="line">					&#125;</span><br><span class="line">					*lpAddr = (ULONG)DetourFunc;<span class="comment">//修改地址</span></span><br><span class="line">					result = TRUE;</span><br><span class="line">					<span class="comment">//恢复内存地址</span></span><br><span class="line">					<span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, dwOldProtect, <span class="number">0</span>);</span><br><span class="line">					cout &lt;&lt; <span class="string">&quot;目标函数：&quot;</span> &lt;&lt; szFuncName &lt;&lt; <span class="string">&quot;地址被Hook为&quot;</span> &lt;&lt; DetourFunc &lt;&lt;<span class="string">&quot;。&quot;</span>&lt;&lt; endl;</span><br><span class="line">					</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			pThunkData++;</span><br><span class="line">		&#125;</span><br><span class="line">		pImportDescriptor++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">FreeLibrary</span>(hModule);</span><br><span class="line"></span><br><span class="line">	oldMessageBox = (POI_MessageBoxA)pOriginalFuncAddr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实验结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2023/10/16/note20200821/success1.PNG"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2023/10/16/note20200821/success2.PNG"></p>
<h3 id="虚函数Hook"><a href="#虚函数Hook" class="headerlink" title="虚函数Hook"></a>虚函数Hook</h3><p>几个注意点：</p>
<ol>
<li>确定目标函数在目标雷中的位置以及函数原型；</li>
<li>定义DetourClass和TrampolineClass；</li>
<li>修改虚函数表实现Hook；</li>
</ol>
<h3 id="SSDT-Hook"><a href="#SSDT-Hook" class="headerlink" title="SSDT Hook"></a>SSDT Hook</h3><ol>
<li>定义Detour函数以及一个函数指针；</li>
<li>通过硬编码方式检索系统版本，找出SSDT索引；</li>
<li>去掉虚拟页写保护，这里可以通过清楚CPU控制寄存器cr0；</li>
<li>安装Hook；</li>
</ol>
<h2 id="Inline-Hook实施过程"><a href="#Inline-Hook实施过程" class="headerlink" title="Inline Hook实施过程"></a>Inline Hook实施过程</h2><p>几个概念：</p>
<ol>
<li>TargetFun：用被Hook的目标函数；</li>
<li>DetourFun：用于替代TargrtFun的自定义函数；</li>
<li>TrampolineFun：调用函数的入口。在该函数中要执行的TargetFun中被替换的前几条指令；</li>
</ol>
<h3 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h3><p>这里针对<code>MessageBoxA</code>进行实验。</p>
<ol>
<li>确定Hook方式以及在TrampolineFun中使用的指令；</li>
</ol>
<p>可以观察到<code>MessageBoxA</code>函数开头如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">763E13D0    8BFF            <span class="keyword">mov</span> <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line">763E13D2    <span class="number">55</span>              <span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line">763E13D3    8BEC            <span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br></pre></td></tr></table></figure>

<p>正好是5个字节，使用长跳的机器码进行Inline Hook，即将这几个字节修改为如下形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E9 xx xx xx xx</span><br></pre></td></tr></table></figure>

<p>当Detour函数执行完毕，需要使用TrampolineFun调用这三条指令来正常调用原函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov edi,edi</span><br><span class="line">push ebp</span><br><span class="line">mov ebp,esp</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置TrampolineFun函数；</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PBYTE AddrMessageBoxA = </span><br><span class="line">(PBYTE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">&quot;user32.dll&quot;</span>), <span class="string">&quot;MessageBoxA&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//TrampolineFun，保存原函数正常执行</span></span><br><span class="line">__declspec(naked)</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">OriginalMessageBox</span><span class="params">(HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption, UINT uType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_asm &#123;</span><br><span class="line">		mov edi,edi</span><br><span class="line">		push ebp</span><br><span class="line">		mov ebp,esp</span><br><span class="line">		jmp g_JmpBackAddr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将jmp指令写入，并设置TrampolineFun即可；</li>
</ol>
<p>这里为了方便显示Hook的结果，写了个小程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"><span class="keyword">using</span> std::cin;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">show_msg</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">show_several_bytes</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">show_byte</span><span class="params">(ULONG addr, <span class="type">int</span> length = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;TEST YOUR HOOK&quot;</span> &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;1.show messagebox;&quot;</span> &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;2.show several bytes of the api;&quot;</span> &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;input the index:&quot;</span> &lt;&lt; endl;</span><br><span class="line">		<span class="type">char</span> input;</span><br><span class="line">		cin &gt;&gt; input;</span><br><span class="line">		<span class="keyword">if</span> (input == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">			<span class="built_in">show_msg</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (input == <span class="string">&#x27;2&#x27;</span>) &#123;</span><br><span class="line">			<span class="built_in">show_several_bytes</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;WRONG INPUT!\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		cout &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">show_msg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">&quot;pop-ups&quot;</span>, <span class="string">&quot;pop-ups&quot;</span>, MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">show_several_bytes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	HMODULE user32_mod = <span class="built_in">GetModuleHandle</span>(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">	ULONG msgbox_addr = (ULONG)<span class="built_in">GetProcAddress</span>(user32_mod, <span class="string">&quot;MessageBoxA&quot;</span>);</span><br><span class="line">	<span class="built_in">show_byte</span>(msgbox_addr, <span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">show_byte</span><span class="params">(ULONG addr, <span class="type">int</span> length)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;0x%p 开始的 %d 个字节：&quot;</span>, addr, length);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">		BYTE t;</span><br><span class="line">		__asm &#123;</span><br><span class="line">			mov		eax, addr</span><br><span class="line">			mov		al, byte ptr[eax]</span><br><span class="line">			mov		t, al</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>, t);</span><br><span class="line">		addr = addr + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果（这里由于没有对源代码的一部分进行修改导致了地址的错误，这里就演示一下字节的修改）：</p>
<p>Hook前：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2023/10/16/note20200821/success3.PNG"></p>
<p>Hook后：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2023/10/16/note20200821/success4.PNG"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2023/10/16/note20200821/success5.PNG"></p>
<h3 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h3><ol>
<li>使用<code>ReadProcessMemory</code>以及<code>WriteProcessMemory</code>函数可以方便的读写内存；</li>
<li>方便的显示指定地址字节的内容的函数设计：</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">show_byte</span><span class="params">(ULONG addr, <span class="type">int</span> length)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;0x%p 开始的 %d 个字节：&quot;</span>, addr, length);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">		BYTE t;</span><br><span class="line">		__asm &#123;</span><br><span class="line">			mov		eax, addr</span><br><span class="line">			mov		al, byte ptr[eax]</span><br><span class="line">			mov		t, al</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>, t);</span><br><span class="line">		addr = addr + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Hook的检测"><a href="#Hook的检测" class="headerlink" title="Hook的检测"></a>Hook的检测</h1><h2 id="Address-Hook检测"><a href="#Address-Hook检测" class="headerlink" title="Address Hook检测"></a>Address Hook检测</h2><p>寻找原始的Address,与当前Address进行对比。 </p>
<ol>
<li>IAT Hook：加载待检测的PE模块，然后对IAT进行对比。</li>
<li>SSDT Hook，Shadow SSDT Hook：将内核文件加载，手动计算实际地址，然后进行对比。</li>
<li>一些无法获取确切地址的Hook，检测Address是否再这个驱动模块的地址范围。</li>
</ol>
<h2 id="Inline-Hook检测"><a href="#Inline-Hook检测" class="headerlink" title="Inline Hook检测"></a>Inline Hook检测</h2><p>步骤如下：</p>
<ol>
<li>加载待检测的PE映像，根据实际地址进行重定位。</li>
<li>对代码所在的节进行检查和比对。</li>
</ol>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avater.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avater.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Ivoripuion</div><div class="post-copyright__author_desc">开心就好</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2023/10/16/note20200821/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2023/10/16/note20200821/')">note20200821</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2023/10/16/note20200821/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=http://example.com/2023/10/16/note20200821/&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">米惜</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E7%AC%94%E8%AE%B0/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>笔记<span class="tagsPageCount">55</span></a><a class="post-meta__box__tags" href="/tags/%E9%80%86%E5%90%91/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>逆向<span class="tagsPageCount">12</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/cover/%E8%A5%BF%E7%93%9C%E4%B9%A6.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/10/16/note20200629/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">note20200629</div></div></a></div><div class="next-post pull-right"><a href="/2023/10/16/note20200903/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">note20200903</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/10/16/note20210514/" title="note20210514"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">note20210514</div></div></a></div><div><a href="/2023/10/16/note20210509/" title="note20210509"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">note20210509</div></div></a></div><div><a href="/2023/10/16/note20200903/" title="note20200903"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">note20200903</div></div></a></div><div><a href="/2023/10/16/note20200629/" title="note20200629"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">note20200629</div></div></a></div><div><a href="/2023/10/16/note20200611/" title="note20200611"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-16</div><div class="title">note20200611</div></div></a></div><div><a href="/2020/06/04/note20200604/" title="note20200604"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2020-06-04</div><div class="title">note20200604</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avater.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/state.png" ait="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">对<b style="color:#fff">云安全、二进制安全、精神分析</b>相关的主题感兴趣，分享包括但不限于<b style="color:#fff">笔记</b>、<b style="color:#fff">随想</b>、<b style="color:#fff">热点分析</b>等内容。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">感谢你对本站点的访问和阅读。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Ivoripuion</h1><div class="author-info__desc">开心就好</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/Ivoripuion" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/13703678" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text">Hook的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Address-Hook"><span class="toc-number">1.1.</span> <span class="toc-text">Address Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E7%B1%BB%E8%A1%A8%E4%B8%AD%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">1.1.1.</span> <span class="toc-text">各类表中的地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E4%BE%8B%E7%A8%8B%E5%9C%B0%E5%9D%80"><span class="toc-number">1.1.2.</span> <span class="toc-text">处理例程地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E5%9F%BA%E7%A1%80%E5%99%A8%E4%B8%AD%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">1.1.3.</span> <span class="toc-text">特殊基础器中的地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E5%AE%9A%E7%9A%84%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="toc-number">1.1.4.</span> <span class="toc-text">特定的函数指针</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Inline-Hook"><span class="toc-number">1.2.</span> <span class="toc-text">Inline Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jmp-xxxxxxxx-5%E5%AD%97%E8%8A%82"><span class="toc-number">1.2.1.</span> <span class="toc-text">jmp xxxxxxxx(5字节)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#push-xxxxxxxx-ret-6%E5%AD%97%E8%8A%82"><span class="toc-number">1.2.2.</span> <span class="toc-text">push xxxxxxxx&#x2F;ret(6字节)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mov-eax-xxxxxxx-jmp-eax-7%E5%AD%97%E8%8A%82"><span class="toc-number">1.2.3.</span> <span class="toc-text">mov eax,xxxxxxx&#x2F;jmp eax(7字节)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-Hook-%E6%9B%B4%E6%8D%A2%E6%8C%87%E4%BB%A4%E6%88%96%E8%BE%93%E5%85%A5%E8%A1%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">call Hook(更换指令或输入表)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HotPatch-Hook"><span class="toc-number">1.2.5.</span> <span class="toc-text">HotPatch Hook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84Hook"><span class="toc-number">1.3.</span> <span class="toc-text">基于异常处理的Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E4%B8%8D%E6%98%AFHook%E7%9A%84Hook"><span class="toc-number">1.4.</span> <span class="toc-text">一些不是Hook的Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PE%E6%96%87%E4%BB%B6%E8%A2%AB%E6%84%9F%E6%9F%93%EF%BC%8C%E5%AF%BC%E8%87%B4OEP%E8%A2%AB%E4%BF%AE%E6%94%B9"><span class="toc-number">1.4.1.</span> <span class="toc-text">PE文件被感染，导致OEP被修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6%E5%92%8C%E5%88%86%E5%B1%82%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">系统回调机制和分层模型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook%E4%BD%8D%E7%BD%AE%E7%9A%84%E6%8C%91%E9%80%89"><span class="toc-number">2.</span> <span class="toc-text">Hook位置的挑选</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook%E7%9A%84%E5%85%B8%E5%9E%8B%E8%BF%87%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">Hook的典型过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Address-Hook%E5%AE%9E%E6%96%BD%E8%BF%87%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">Address Hook实施过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IAT-Hook"><span class="toc-number">3.1.1.</span> <span class="toc-text">IAT Hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E5%87%BD%E6%95%B0Hook"><span class="toc-number">3.1.2.</span> <span class="toc-text">虚函数Hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSDT-Hook"><span class="toc-number">3.1.3.</span> <span class="toc-text">SSDT Hook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Inline-Hook%E5%AE%9E%E6%96%BD%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">Inline Hook实施过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">具体过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tips"><span class="toc-number">3.2.2.</span> <span class="toc-text">tips</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook%E7%9A%84%E6%A3%80%E6%B5%8B"><span class="toc-number">4.</span> <span class="toc-text">Hook的检测</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Address-Hook%E6%A3%80%E6%B5%8B"><span class="toc-number">4.1.</span> <span class="toc-text">Address Hook检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Inline-Hook%E6%A3%80%E6%B5%8B"><span class="toc-number">4.2.</span> <span class="toc-text">Inline Hook检测</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/11/02/%E6%B2%B3%E8%BE%B9%E7%9A%84%E5%8E%9F%E4%B9%90/" title="河边的原乐"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E6%B2%B3%E8%BE%B9%E7%9A%84%E9%94%99%E8%AF%AF.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="河边的原乐"/></a><div class="content"><a class="title" href="/2023/11/02/%E6%B2%B3%E8%BE%B9%E7%9A%84%E5%8E%9F%E4%B9%90/" title="河边的原乐">河边的原乐</a><time datetime="2023-11-02T14:43:30.000Z" title="发表于 2023-11-02 22:43:30">2023-11-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/01/%E3%80%8A%E8%A5%BF%E7%93%9C%E4%B9%A6%E3%80%8B%E7%AC%94%E8%AE%B0/" title="《西瓜书》笔记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E8%A5%BF%E7%93%9C%E4%B9%A6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《西瓜书》笔记"/></a><div class="content"><a class="title" href="/2023/11/01/%E3%80%8A%E8%A5%BF%E7%93%9C%E4%B9%A6%E3%80%8B%E7%AC%94%E8%AE%B0/" title="《西瓜书》笔记">《西瓜书》笔记</a><time datetime="2023-11-01T14:34:43.000Z" title="发表于 2023-11-01 22:34:43">2023-11-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/30/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AF%B4%E7%8A%B9%E5%A4%AA%E4%BA%BA%E5%9C%A8%E6%8E%92%E7%8A%B9/" title="为什么说犹太人在排犹"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="为什么说犹太人在排犹"/></a><div class="content"><a class="title" href="/2023/10/30/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AF%B4%E7%8A%B9%E5%A4%AA%E4%BA%BA%E5%9C%A8%E6%8E%92%E7%8A%B9/" title="为什么说犹太人在排犹">为什么说犹太人在排犹</a><time datetime="2023-10-30T14:35:27.000Z" title="发表于 2023-10-30 22:35:27">2023-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/22/%E7%94%B1XSS%E5%88%B0%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="由XSS到网络安全"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E4%BA%91%E5%AE%89%E5%85%A8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="由XSS到网络安全"/></a><div class="content"><a class="title" href="/2023/10/22/%E7%94%B1XSS%E5%88%B0%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" title="由XSS到网络安全">由XSS到网络安全</a><time datetime="2023-10-21T16:43:57.000Z" title="发表于 2023-10-22 00:43:57">2023-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/16/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8EPE%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F%E6%96%B9%E6%B3%95%E7%9A%84%E7%A0%94%E7%A9%B6%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/cover/%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）"/></a><div class="content"><a class="title" href="/2023/10/16/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8EPE%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F%E6%96%B9%E6%B3%95%E7%9A%84%E7%A0%94%E7%A9%B6%E4%B8%8E%E5%AE%9E%E7%8E%B0/" title="一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）">一种基于PE文件的信息隐藏方法的研究与实现（信息隐藏相关）</a><time datetime="2023-10-16T15:29:03.909Z" title="发表于 2023-10-16 23:29:03">2023-10-16</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="http://ivoripuion.github.io" title="Ivoripuion@2023">Ivoripuion@2023</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">11</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://ivoripuion.github.io/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/Ivoripuion" title="米惜的github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/me.jpg" alt="米惜的github"/><span class="back-menu-item-text">米惜的github</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=870146543&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BAS/" style="font-size: 0.88rem;">BAS<sup>1</sup></a><a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">Java安全<sup>2</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>5</sup></a><a href="/tags/Windows/" style="font-size: 0.88rem;">Windows<sup>9</sup></a><a href="/tags/blackhat2023/" style="font-size: 0.88rem;">blackhat2023<sup>1</sup></a><a href="/tags/fuzz/" style="font-size: 0.88rem;">fuzz<sup>6</sup></a><a href="/tags/pwn/" style="font-size: 0.88rem;">pwn<sup>1</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>1</sup></a><a href="/tags/%E4%B8%B4%E5%BA%8A/" style="font-size: 0.88rem;">临床<sup>2</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">二进制安全<sup>2</sup></a><a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">云安全<sup>4</sup></a><a href="/tags/%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F/" style="font-size: 0.88rem;">信息隐藏<sup>1</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" style="font-size: 0.88rem;">内存马<sup>1</sup></a><a href="/tags/%E5%88%91%E6%B3%95/" style="font-size: 0.88rem;">刑法<sup>1</sup></a><a href="/tags/%E5%89%A7%E6%9C%AC%E6%9D%80%E8%A7%A3%E6%9E%90/" style="font-size: 0.88rem;">剧本杀解析<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%9C%A8%E4%B8%BB%E4%B9%89/" style="font-size: 0.88rem;">存在主义<sup>3</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 0.88rem;">实战<sup>3</sup></a><a href="/tags/%E5%AE%9E%E8%B7%B5/" style="font-size: 0.88rem;">实践<sup>5</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">开发<sup>1</sup></a><a href="/tags/%E6%96%87%E5%AD%A6%E9%89%B4%E8%B5%8F/" style="font-size: 0.88rem;">文学鉴赏<sup>1</sup></a><a href="/tags/%E6%97%A5%E8%AF%AD/" style="font-size: 0.88rem;">日语<sup>1</sup></a><a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 0.88rem;">机器学习<sup>1</sup></a><a href="/tags/%E6%B3%95%E5%AD%A6/" style="font-size: 0.88rem;">法学<sup>1</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="font-size: 0.88rem;">漏洞分析<sup>22</sup></a><a href="/tags/%E7%97%85%E6%AF%92%E6%A3%80%E6%B5%8B/" style="font-size: 0.88rem;">病毒检测<sup>2</sup></a><a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 0.88rem;">笔记<sup>55</sup></a><a href="/tags/%E7%B2%BE%E7%A5%9E%E5%88%86%E6%9E%90/" style="font-size: 0.88rem;">精神分析<sup>11</sup></a><a href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91%E4%B8%BB%E6%9C%BA%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">腾讯云主机安全<sup>1</sup></a><a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size: 0.88rem;">论文阅读<sup>1</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 0.88rem;">逆向<sup>12</sup></a><a href="/tags/%E9%98%85%E8%AF%BB%E7%90%86%E8%A7%A3/" style="font-size: 0.88rem;">阅读理解<sup>1</sup></a><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 0.88rem;">随笔<sup>4</sup></a><a href="/tags/%E9%9D%9E%E9%81%93%E5%BE%B7%E4%B8%BB%E4%B9%89/" style="font-size: 0.88rem;">非道德主义<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 0.88rem;">面试题<sup>1</sup></a><a href="/tags/%E9%A9%AC%E5%85%8B%E6%80%9D%E4%B8%BB%E4%B9%89/" style="font-size: 0.88rem;">马克思主义<sup>3</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8030065748" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=8030065748&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("01/01/2022 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2022 By 安知鱼 V1.6.8",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Ivoripuion 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "visitor@anheyu.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script id="click-heart" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":225,"height":450},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>